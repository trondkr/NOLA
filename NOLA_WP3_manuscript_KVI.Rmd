---
output: 
 
   word_document:
    reference_docx: draft-styles-word.docx
    fig_caption: true # Make sure images are treated as figures
    number_sections: false # Number sections
    #toc: true # Gives Table of Contents 
    #toc_depth: 2
    pandoc_args:
    - '--lua-filter=scholarly-metadata.lua'
    - '--lua-filter=author-info-blocks.lua'
bibliography: library.bib
csl: frontiers-in-marine-science.csl
title: "Seasonal and interannual variation in river water influence in a sub-Arctic fjord"
author:
  - Kristina Ø. Kvile:
      email: kristina.kvile@niva.no
      institute: [NIVA]
      correspondence: true
  - name: Michael Bedington
    institute: [apn]
  - name: Trond Kristiansen
    institute: [NIVA]
  - name: Jon Albretsen
    institute: [IMR]
  - name: Angelika H.H. Renner
    institute: [IMR]
  - name: Amanda Poste 
    institute: [NIVA]
institute:
  - NIVA: Norwegian Institute for Water Research, Oslo, Norway
  - apn: Akvaplan-Niva AS, Oslo, Norway
  - IMR: Institute of Marine Research, Bergen, Norway
abstract: "**Abstract**: *Introduction:* Climate change effects on freshwater fluxes in coastal ecosystems. *Method*: Particle tracking runs to simulate material originating from the river (dissolved or particulate), following the fate of material released at the Målselv river mouth into the Malangen fjord and eventually entering the Norwegian Sea. *Results*: Seasonal and interannual variation in residence time of river material, spatial extent of river material. Differences between dissolved (neutral) and particulate (sinking) material. *Discussion*: Inputs from rivers to coast, potential ecological effects (light and nutrient availability, stratification)."
editor_options: 
  chunk_output_type: console
  always_allow_html: true
---


```{r settings, include=FALSE}
#rm(list = ls())
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
knitr::opts_chunk$set(fig.retina = 1)

setwd("C:/NOLA-SIS_lokal/NOLA")

# libraries
library(ncdf4)
library(maps)
library(mapdata)
library(ggmap)
library(tidyverse)
library(sp)
library(raster)
library(captioner)
library(knitr)
library(grid)
library(gridExtra)
library(zoo)
library(flextable)


# Function to find first day of given month
firstDayMonth=function(x)
{           
  x=as.Date(as.character(x))
  day = format(x,format="%d")
  monthYr = format(x,format="%Y-%m")
  y = tapply(day,monthYr, min)
  first=as.Date(paste(row.names(y),y,sep="-"))
}


# Map basics
landcol<-"gray91"#"darkslategrey"
oceancol<-"white" #"deepskyblue4"

maparea_all <- ggplot() +
  geom_polygon(data = map_data("worldHires"), aes(x = long, y = lat, group = group), # Change to worldHires later
               colour = landcol, fill = landcol) +
  coord_cartesian(xlim = c(16.1, 21.8), ylim = c(69.2, 70.35) ) + 
  theme(axis.title.x=element_blank(),axis.title.y=element_blank(),
        panel.background=element_rect(fill = oceancol, colour = oceancol),
        panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5)) 


maparea_zoom <- ggplot() +
  geom_polygon(data = map_data("worldHires"), aes(x = long, y = lat, group = group), # Change to worldHires later
               colour = landcol, fill = landcol) +
  coord_cartesian(xlim = c(17.7, 19.2), ylim = c(69.28, 69.7) ) + 
  theme(axis.title.x=element_blank(),axis.title.y=element_blank(),
        panel.background=element_rect(fill = oceancol, colour = oceancol),
        panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5)) 

# Figure labels
figs <- captioner(prefix="Figure")


study_area <- figs(name="study_area","Study area. The background map shows the location of the study area (black rectangle), and the inset shows the details of the study area. The black points show the particle release area at the mouth of the Målselv river. The colored boxes and dashed line show the limits of subareas used to quantify the distribution of river material (Outside: north of the Outer box).")

particle_release <- figs(name="particle_release","Number of particles released per day (A), the cumulative number of particles during the run (B), and the river volume flux per date for 2018 (C) and 2019 (D). The released particles (A) were scaled by the river volume flux (C, D) to represent the amount of river material. Panels A and B are illustrated for one year, but the setup is the same for both years.")

particle_depth <- figs(name="particle_depth","Mean depth of particles per day throughout the different runs (not weighted by water volume at day of release), with 25 % and 75 % percentiles of the data indicated as grey shading.")

num_particles <- figs(name="num_particles","Cumulative distribution of river material during the simulations (counting all particles that have passed through a grid cell, with particles weighted by river water volume flux at the day of release). The top panels show the full distribution and the lower panels a zoomed-in view of the Malangen system (indicated with a black rectangle in the upper panel). Runs for two years with neutrally buoyant or sinking particles are compared. Note that the color scale has been truncated to a maximum of 15 000 for all panels to facilitate visualization and comparison (the maximum value for a single grid cell is indicated in the title).")

num_particles_day <- figs(name="num_particles_day","Distribution of river water material in the study area at the first day of every 2nd month during the simulation (counting all particles that are in a grid cell that day, weighting particles by river water volume flux at the day of release). Runs with neutrally buoyant and sinking particles are compared (different columns). Note that the color scale has been truncated to a maximum of 100 to allow comparison and visualization (the maximum value for a single for a single grid cell is indicated per panel).")

num_particles_box <- figs(name="num_particles_box","Sum of material (number of particles weighted by volume) present within each subregion of the study area per day during the simulation, color-coded by release month. Note, the different colors do not overlap but are stacked vertically.")

residence_time_box <- figs(name="residence_time_box","Residence time of particles in each box (in number of days) as a function of total volume flux at the time of particle release (5-days moving average counting from the day of release). Note that this may also include particles that exit a box and then re-enters at a later point in time. The grey points are number of days for individual particles (not weighted by water volume) and the black line show the relationship between residence time and total volume flux as a smooth function from a GAM (y ~ s(x, bs = 'cs')).")

age_particles_day <- figs(name="age_particles_day","Age distribution of particles at the first day of every 2nd month during the simulation (calculating the mean age for all particles that are in a grid cell that day). Note that all values over 250 are diplayed in the same color (maximum outlier value was 302).")


```


```{r read_opendrift_output, include=FALSE}
years <- c(2018,2019)
runs<-c("neutralParticles","sinkingParticles_-0.0003ms","sinkingParticles_-0.0008ms")

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  
for(i in 1:3){
  run_name <- paste0(runs[i],"_",timespan)
  resultfile <- paste0("../results/",run_name,".nc")
  DriftFile <- nc_open(resultfile, write=FALSE) #for nc
  #print(DriftFile)
  #id  <- ncvar_get(DriftFile, 'trajectory')  # Particle ID
  #Create vector of timesteps in days:
  timesteps  <- ncvar_get(DriftFile, 'time')  # seconds since 1970-01-01 00:00:00 
  dates <- as.Date(as.POSIXct(timesteps, origin="1970-01-01"))
  
  days_timestep<-diff(timesteps)[1]/(60*60*24) #days per timestep
  timesteps_days<-rep(NA,length(timesteps));timesteps_days[1]<-days_timestep 
  for (j in 2:length(timesteps_days)){timesteps_days[j]<-timesteps_days[j-1]+days_timestep}
  timesteps_days_rounded<-ceiling(timesteps_days)

  dates_days <- data.frame(day=timesteps_days_rounded,date=dates)
    assign(paste0("dates_days", year), dates_days)
  
  #Extract relevant variables
  status <- ncvar_get(DriftFile, 'status')    #0=active,<0=stranded/not yet released
  release_month <- ncvar_get(DriftFile, 'origin_marker');release_month[status<0]<-NA
  lon <- ncvar_get(DriftFile, 'lon');lon[status<0]<-NA
  lat <- ncvar_get(DriftFile, 'lat');lat[status<0]<-NA
  depth <- ncvar_get(DriftFile, 'z');depth[status<0]<-NA
  age_seconds <- ncvar_get(DriftFile, 'age_seconds');age_seconds[status<0]<-NA
  age_days <- floor(age_seconds/(60*60*24))
  bottom_depth <- ncvar_get(DriftFile, 'sea_floor_depth_below_sea_level');bottom_depth[status<0]<-NA
  
  nc_close(DriftFile)
  
  # Make dataframe of relevant variables
  dayvector <- rep(timesteps_days_rounded, each = dim(release_month)[2])
  datevector <- rep(dates, each = dim(release_month)[2])
  
  dat <- pivot_longer(as.data.frame(release_month), cols= 1:dim(release_month)[2], values_to = "release_month", names_to = "ID")  %>%
        mutate(day=dayvector)  %>%
        mutate(date=datevector)  %>%
        mutate(age=c(t(age_days)))  %>%
        mutate(lon=c(t(lon)))  %>%
        mutate(lat=c(t(lat)))  %>%
        mutate(depth=c(t(depth)))   %>%
        mutate(bottom_depth=c(t(bottom_depth)))   %>%
        filter(!is.na(release_month))
    
  assign(paste0(run_name,"_dat"), dat)
  rm(resultfile, DriftFile, timesteps, days_timestep, timesteps_days, timesteps_days_rounded, release_month, status, lon, lat, depth, age_seconds, age_days, datevector)
}
  # The number of particles per timestep is the same for all runs
  num_particles_timestep <- dat %>% 
  group_by(date) %>% 
  summarize(total = n_distinct(ID))  %>% 
  mutate(new = total - lag(total))   %>% 
  mutate(new = replace_na(new, 10))
  
  assign(paste0("num_particles_timestep_", year), num_particles_timestep)
  rm(num_particles_timestep)
}


```

```{r read_river_file, include=FALSE}
RiverFile <- nc_open(paste0("../NorKyst_files/norfjords_160m_river.nc"), write=FALSE) #for nc
#print(RiverFile)
river_num <- ncvar_get(RiverFile, 'river')  # river number
timesteps_river <- ncvar_get(RiverFile, 'river_time')  # days since 1948-01-01 00:00:00 
dates_river <- as.Date(timesteps_river, origin="1948-01-01")

transport <- ncvar_get(RiverFile, 'river_transport') #river runoff vertically integrated mass transport, units: meter3 second-1 (day??)

timespan_min <- paste0(min(years), "-02-01")
timespan_max <- paste0(max(years), "-12-31-1")

dates_sel <- which(dates_river >= timespan_min & dates_river <= timespan_max)

river_sel <- 167 # Målselv

transport <- transport[river_sel, dates_sel]
#transport <- transport/1000 #(convert to m3^-1000)

transport <- data.frame(release_date=dates_river[dates_sel], transport=transport)
nc_close(RiverFile)

rm(river_num, timesteps_river, RiverFile, dates_sel, river_sel, dates_river)
```

```{r scale_by_river_volume, include=FALSE}

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  num_particles_timestep <- get(paste0("num_particles_timestep_",year))
                                
  for(x in 1:3){
  run_name <- paste0(runs[x],"_",timespan)
  
 # Full join doesn't work with dates  
  dat_releaseday <- get(paste0(run_name,"_dat")) %>%
    group_by(ID) %>% 
    slice(1)  %>% 
    mutate(release_date = as.character(date)) %>% 
    dplyr::select(c(ID,release_date))

  dat <- get(paste0(run_name,"_dat")) %>%
    mutate(date = as.character(date)) %>%
    left_join(dat_releaseday) %>%
    left_join(transport %>% mutate(release_date = as.character(release_date))) %>%
    left_join(num_particles_timestep %>% mutate(release_date = as.character(date)) %>% dplyr::select(release_date, new)) %>%
    mutate(vol_particle = transport/new) %>%
    dplyr::select(!(new))  %>%
    mutate(date = as.Date(date))
  
  assign(paste0(run_name,"_dat"), dat)

  }
}

rm(dat_releaseday)
```

```{r define_boxes, include=FALSE}

local_box_lon = c(18.462861, 18.562647)
local_box_lat = c(69.304173, 69.357645)

inner_box_lon = c(18.5627, 19.05)
inner_box_lat = c(69.25, 69.357645)

middle_box_lon = c(18.349934, 18.718452)
middle_box_lat = c(69.357645, 69.438920)

outer_box_lon = c(17.823399, 18.718452)
outer_box_lat = c(69.438921, 69.571700)

# outer_box_lon = c(17.308940, 18.135973)
# outer_box_lat = c(69.571701, 69.71448)

outside_lat <-  69.571701

#Set resolution 
reso <- c(0.01,0.005)

#Creating raster for full study area (note, reducing full area to remove particles that meet the borders of NorKyst)
i<-1 
dat <- get(paste0(runs[i],"_",timespan,"_dat"))

fullRaster <- raster(resolution = reso, xmn=16.1, xmx=21.8, ymn=69.2, ymx=70.35)

localRaster <- raster(resolution = reso, xmn=min(local_box_lon), xmx=max(local_box_lon), ymn=min(local_box_lat), ymx=max(local_box_lat))


```



# Introduction
*	Importance of rivers for transport of nutrients/C/particles to the sea
* Broad climate change context for the global north and for Northern Norway 
    + Climate change is causing increased precipitation and more frequent high flow events, which lead to increased runoff to coastal waters. 
    + Increased runoff can lead to coastal darkening, due to increased input of dissolved and suspended material that absorbs and scatters light (e.g. ...). 
    + In addition, runoff from land bring nutrients that can support increased phytoplankton production, which again may reduce light availability at the seafloor. 
    + Documented darkening of Norwegian coastal waters
*	Difference between dissolved (e.g. nutrients) and particulate (e.g. sediment particles) matter in behavior, residence time…
*	Importance of residence time for the effect of river water in fjord systems
*	If the residence time is very short, does the river output matter?
*	Importance of spatial extent – how far does the river output reach? 
*	Seasonal variation (spring freshet, degree of wind mixing)

## Aims
For a northern Norwegian case study site (Malangen), use high-resolution particle-tracking modeling to study the seasonality of river outflow and residence time of river water in the fjord to better understand the potential effect of seasonality and high flow events for fjord biogeochemistry and coastal darkening.  
        

# Methods

## Study area
The study area encompasses the mouth of the Målselv river in Northern Norway and the downstream Malangen fjord that can transport river water out into the Norwegian Sea (`r figs("study_area", display = "cite")`). This river fjord system has been the subject of previous observational studies focusing on organic matter and nutrient dynamics along the freshwater-marine continuum, providing valuable background data for the current study (e.g. Frigstad et al. 2020, Schultze et al. 2022). The study area was divided into five different subareas at varying distancedifferent subareas at varying distance from the river mouth to study the flux of river water and residence time.  

```{r study_area, fig.cap = study_area, fig.height = 4, fig.width = 7}
#Plot distribution at release
overview <- maparea_all +
  coord_cartesian(xlim = c(5, 30), ylim = c(59, 72))  +   
  geom_rect(linewidth=1, aes(xmin = 17.4, xmax = 19.25, ymin = 69.25, ymax= 69.7), fill=NA,color="black") 

zoomed <- maparea_all +
  coord_cartesian(xlim = c(17.4, 19.25), ylim = c(69.25, 69.7)) + 
  geom_rect(aes(xmin = min(local_box_lon), xmax = max(local_box_lon), ymin = min(local_box_lat), ymax = max(local_box_lat)), alpha=0.2, fill="red") +
  geom_text(aes(x = min(local_box_lon), y = max(local_box_lat-0.02), label = "Local box"),size = 4, vjust = 0, hjust = 0)+
  geom_rect(aes(xmin = min(inner_box_lon), xmax = max(inner_box_lon), ymin = min(inner_box_lat), ymax = max(inner_box_lat)), alpha=0.1, fill="orange") +
  geom_text(aes(x = max(inner_box_lon-0.25), y = max(inner_box_lat-0.02), label = "Inner box"),size = 4, vjust = 0, hjust = 0)+
  geom_rect(aes(xmin = min(middle_box_lon), xmax = max(middle_box_lon), ymin = min(middle_box_lat), ymax = max(middle_box_lat)), alpha=0.1, fill="green") +
  geom_text(aes(x = min(middle_box_lon), y = max(middle_box_lat-0.02), label = "Middle box"),size = 4, vjust = 0, hjust = 0) +
  geom_rect(aes(xmin = min(outer_box_lon), xmax = max(outer_box_lon), ymin = min(outer_box_lat), ymax = max(outer_box_lat)), alpha=0.1, fill="blue") +
  geom_text(aes(x = min(outer_box_lon), y = max(outer_box_lat-0.02), label = "Outer box"),size = 4, vjust = 0, hjust = 0) +
  geom_hline(yintercept= outside_lat, linetype="dashed") +
  geom_text(aes(x = min(outer_box_lon)-0.1, y = outside_lat+0.01, label = "Outside"),size = 4, vjust = 0, hjust = 0)+
  geom_point(data=dat  %>% filter(day==1),
             aes(x = lon, y = lat), size=0.1,color="black")  +
  geom_text(aes(x = max(local_box_lon), y = min(local_box_lat-0.04), label = "Release area"),size = 4, vjust = 0, hjust = 0) +
  geom_segment(aes(x = max(local_box_lon)+0.03, y = min(local_box_lat)-0.03, xend = mean(local_box_lon)+0.01, yend = min(local_box_lat)-0.002),
               arrow = arrow(length = unit(0.2, "cm")))

overview + annotation_custom(ggplotGrob(zoomed), xmin = 15, xmax = 31, 
                       ymin = 58.5, ymax = 67)
```

## Simulating drift of material from river to ocean
We released particles in a band from 18.538°E/69.308°N to 18.506°E/69.306°N following river mouth of the Målselv river (`r figs("study_area", display = "cite")`). The particles were distributed randomly at depths between 0 and 5 m. We started the particle drift simulation on the 1st of February for each of two years (2018, 2019) and followed the drift of particles until the end of the same year (31st of December, i.e., each year was simulated separately). We released 100 particles per day from the 1^st^ of February until the end of September, i.e., a total of 24 200 particles per year (`r figs("particle_release", display = "cite")`).   

To get a more realistic representation of the seasonal variation in outflow of river material, we scaled the particles by the total river water volume flux at the release day (vertically integrated mass transport, in m^3-s^), provided by the Norwegian Water Resources and Energy Directorate (NVE). I.e., the particles released at a specific day were weighted by the volume flux at that day, divided by the total number of particles released that day. In that way, particles released during the spring and summer flood period are given more weight in the analyses and the "amount" represented by the particles reflect the volume flux (`r figs("particle_release", display = "cite")`).  

```{r particle_release, fig.cap = particle_release, fig.height = 6, fig.width = 7}

newp <- 
  ggplot(data=num_particles_timestep_2018, aes(x=date,y=new)) +
  geom_bar(stat="identity", fill = "light blue", width = 0.5)+
  ylab("Particles released daily") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("A")

allp <- 
  ggplot(data=num_particles_timestep_2018, aes(x=date,y=total)) +
  geom_bar(stat="identity", fill ="light blue", width = 0.5)+
  ylab("Number of active particles") +
  theme_minimal()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("B")


volp2018 <- ggplot(data=transport  %>%
                     filter(release_date<"2019-01-01"),
                   aes(x=release_date,y=transport)) +
  geom_bar(stat="identity", fill ="light blue", width = 0.5) +
  ylim(c(0,940)) +
  ylab("Total vol. flux (m3/d)") +
  theme_minimal()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("C") + xlab("date")

volp2019 <- ggplot(data=transport  %>%
                     filter(release_date>="2019-01-01"), aes(x=release_date,y=transport)) +
  geom_bar(stat="identity", fill ="light blue", width = 0.5) +
  ylim(c(0,940)) +
  ylab("Total vol. flux (m3/d)") +
  theme_minimal()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("D") + xlab("date")

grid.arrange(newp, allp, volp2018, volp2019, ncol=2)  

```

To model particle drift with ocean currents, we used the open-source trajectory modelling framework OpenDrift [@Dagestad2018] which was coupled offline to archived hydrodynamical data from a fjord model covering Malangen and the adjacent fjords and coastal areas using 160m x 160m resolution and 35 vertical levels. The free-surface, terrain-following, primitive equations ocean model ROMS [Regional Ocean Modeling System, http://myroms.org, @Shchepetkin2005, @Haidvogel2008] was applied to reproduce the fjord dynamics and hydrography. The circulation model was initialized on the 1st of March 2017 by model data from the Norwegian Coastal Model system NorKyst800 [presented in detail and validated by @Asplin2020 and operational data accessible at https://thredds.met.no provided by the Norwegian Meteorological Institute, MET-Norway]. Also, open boundary conditions were retrieved from NorKyst800. The atmospheric forcing was provided from AROME MetCoOp (Meteorological Co-operation on Operational Numerical Weather Prediction) 2.5km, the main forecasting system at the MET-Norway [@Muller2017]. Tides from TPXO7.2 global tidal analysis were included [@Egbert2002], and the daily river flow rates used were based on measurements from the NVE, i.e., the same river runoff data as applied in the scaling of the simulated particles. An identical model set up for a Norwegian fjord system further south (Hardangerfjorden) is presented in detail and validated in [@Dalsøren2020].  

We applied two different setups of the particle drift model, one setup where particles represent dissolved material and are neutrally buoyant (i.e., following the vertical movement of water) and one setup where particles represent particulate material and are negatively buoyant (i.e., being influenced by the vertical movement of water but also sinking towards the seafloor with a certain speed). For sinking particles, we tested sinking speeds of 0.3 and 0.8 mm/s, representing mud and sand particles, respectively, with grain size 0.05-0.2 mm (*references, Mike? for now I have only tested 0.3*). The resuspension threshold for sinking particles was set to 0.15 m/s (*references or more info, Mike?*).  

For both the neutrally buoyant and sinking particles, we used the following settings in the particle tracking simulations (*this list is more for our own reference, we probably don't need all the detail in the manuscript...*):  

* Particles that hit land move back to their previous location in the ocean
* Vertical mixing was activated so that particles move vertically according to eddy diffusivity and buoyancy 
* Vertical turbulent mixing was parameterized from wind speed (Sundby, 1983) - *this was included because the vertical diffusivity  included in the Norkyst files included some unrealistic values*
* Vertical advection was activated so that particles are moved vertically according to vertical ocean currents *has minimal impact compared to vertical turbulent mixing and could probably be ignored. Kept for now*
* Horizontal diffusivity was set to 10 m2/s  


`r figs("particle_depth", display = "cite")` shows the mean depth of particles in the different runs (neutral vs. 0.3 mm/s sinking speed). Although sinking particles quickly reach a deeper mean depth than neutrally buoyant particles, sinking particles tend to stay in the upper 100 m and are never deactivated (*why is it so?*).  

```{r particle_depth, fig.cap = particle_depth, fig.height = 4, fig.width = 7}

plotlist <- list()

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")

  for(x in 1:3){
    run_name <- paste0(runs[x],"_",timespan)
    
    plot_dep <- get(paste0(run_name,"_dat")) %>% 
      filter(age != 0) %>%
    ggplot(aes(x=date, y=depth))+ 
   # stat_summary(geom="ribbon", fun.data=mean_cl_normal, fill="grey")+
   stat_summary(geom="ribbon", fun.min = function(x) quantile(x, 0.25), fun.max = function(x) quantile(x, 0.75), fill = "light grey") + 
    stat_summary(geom="line", fun=mean)+
    #coord_cartesian(ylim = c(-90, -10)) +
      coord_cartesian(ylim = c(-130, -10)) +
    theme_minimal() +
    theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
    ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x]))))

    if(x == 1){
    plot_dep <- plot_dep + ylab("Mean particle depth") 
    }

    plotlist <- append(plotlist, list(plot_dep)) 
  }
}

grid.arrange(grobs = plotlist, ncol = 2)  

```



## Analyses

Description of how the data were analyzed, visualized....  

* Cumulative and monthly distribution of river material
* Residence time of river material in the different boxes
* Interannual differences/difference between neutral and buoyant particles


# Results
Cumulatively over the course of the year (February to December), material originating from the Målselv river is distributed throughout the Malangen fjord system, into the Norwegian Sea and north along the Norwegian coast (`r figs("num_particles", display = "cite")`). The highest concentration of material originating from the river is found locally along the eastern coast of inner fjord area, in addition to within the release area (where all river water passes through initially, `r figs("num_particles", display = "cite")`). Comparing neutrally buoyant and sinking material, a higher fraction of the sinking material is kept within the inner fjord system, while much of the neutrally buoyant material is spread throughout and outside the study system.   


```{r num_particles, fig.cap = num_particles, fig.height = 5, fig.width = 7}

cols_order <- c("thistle","purple","blue","green","yellow","orange","red","dark red","black")
plotlist <- list()
zlims <- c(0,15000)

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")

for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  
  # Counting the number of particles:
  # rasterNumParts <- rasterize(x=dat_sp[,"ID"], y=fullRaster, fun="count")
  # rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  #rasterNumParts$Number <- rasterNumParts$ID
 
  # Summing the volume of particles:
  rasterNumParts <- rasterize(x=dat_sp[,"vol_particle"], y=fullRaster, fun="sum")
  rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  rasterNumParts$Number <- rasterNumParts$vol_particle
  
 maxval <- max(rasterNumParts$Number)
 #zlims <- c(0, quantile(rasterNumParts$Number, 0.9999))

  fullmap <- maparea_all + 
  geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
  scale_fill_gradientn(limits = zlims,
                       na.value = "red", #na.value color same as color for max value
                       colours = cols_order) +
  #scale_fill_gradientn(colours=topo.colors(500, alpha=0.4), name="Number") +
  geom_rect(aes(xmin = 17.7, xmax = 19.2, ymin =
                  min(rasterNumParts$y), ymax = 69.7), color="black",fill=NA) + 
  ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x])),
                 "\nMax: ", round(maxval))) +
  theme(legend.position = c(0.85, 0.25), legend.title = element_blank(),
        legend.key.width=unit(3,"mm"),legend.background=element_blank(),
        plot.margin = unit(rep(.5, 4), "lines"),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

 zoommap <- maparea_zoom + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = cols_order) +
    xlab("Lon (°E)") + ylab("Lat (°N)") +
    theme(legend.position = "none", 
          plot.margin = unit(rep(.5, 4), "lines"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.border = element_rect(colour = "black", fill=NA))

plotlist <- append(plotlist, list(fullmap, zoommap)) 
  
rm(dat)
}
}

grid.arrange(grobs = plotlist, layout_matrix = matrix(c(1:8),nrow=2,byrow=FALSE))

```
  
Comparing the distribution of material originating from the river at the first day of every 2nd month during the simulation, the highest concentrations of river material is found in the inner fjord system from July and onward (`r figs("num_particles_day", display = "cite")`), corresponding to the period after the strongest river volume flow (`r figs("particle_release", display = "cite")`). The river water transport before May was stronger in 2019 compared to 2018 (`r figs("particle_release", display = "cite")`), which is reflected in higher concentrations of river material in the inner system in this year in May  (`r figs("num_particles_day", display = "cite")`).  *This figure could be moved to the supplementary material and potentially replaced by an animation.*  

```{r num_particles_day, fig.cap = num_particles_day, fig.height = 12, fig.width = 9}

# `r figs("num_particles_day", display = "cite")` shows the distribution of water at the first day of each month of the simulation. *This figure could be moved to the supplementary material and potentially replaced by an animation.*  

plotlist <- list()
zlims <- c(0,7.4)

for(x in 1:3){
  for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  days <- firstDayMonth(unique(dat_sp$date))[c(4,7,10)]

  for(i in 1:length(days)){
    dat_i <- dat_sp[dat_sp$date==days[i],]
    # Counting the number of particles:
    # rasterNumParts <- rasterize(x=dat_i[,"ID"], y=fullRaster, fun="count")
    # rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    # maxval <- max(rasterNumParts$ID)
    
    # Summing the volume of particles:
    rasterNumParts <- rasterize(x=dat_i[,"vol_particle"], y=fullRaster, fun="sum")
    rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    rasterNumParts$Number <- log(rasterNumParts$vol_particle+1)
    #maxval <- max(rasterNumParts$Number)

    dayplot <- maparea_all +
      coord_cartesian(xlim = c(17.4, 19.25), ylim = c(69.25, 69.7)) + 
      geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    #ggtitle(paste0(days[i], "\nMax: ", round(maxval))) +
    ggtitle(days[i]) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          plot.margin = unit(c(-2,0,-0.5,0), "lines"),
          plot.title=element_text(margin=margin(t=40,b=-20)),
          panel.border = element_rect(colour = "black", fill=NA, size=1))

    plotlist <- append(plotlist, list(dayplot)) 
  } # Days
  } # Year
} # Run

# Get legend
 lastplot <- maparea_all  +
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"), name="log(Volume)") +
    theme(legend.direction = "horizontal") 

  legend <- cowplot::get_legend(lastplot)
  plotlist <- append(plotlist, list(legend))
 

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:6,NA,7:12,19,13:17,18,NA),ncol=3,byrow=FALSE), heights = c(rep(1,6),0.5), top=textGrob(run_name_short))



```

To summarize the distribution of river material through time, `r figs("num_particles_box", display = "cite")` shows the sum of material present within each subarea of the study region (`r figs("study_area", display = "cite")`) per day during the simulation, separated into month of release. Little material is retained within the Local box while a larger fraction is retained within the Inner box, in particular for the sinking material. Material reaching the Outer box seem to pass through this area relatively quickly compared to the Inner box. A larger fraction of neutrally buoyant material reaches the Outside area (north of the Outer box), compared to the sinking material.      

```{r num_particles_box, fig.cap = num_particles_box, fig.height = 8, fig.width = 9}

plotlist <- list()
ylims <- c(0,60000)

for(year in years){
timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:2){
  dat <- get(paste0(runs[x],"_",timespan,"_dat"))
  xlims<-(c(min(dat$date),max(dat$date-1)))
  dates_days <- get(paste0("dates_days",year))
 
 for(i in c("local","inner","outer")){
  lon_i <- get(paste0(i,"_box_lon"))
  lat_i <- get(paste0(i,"_box_lat"))
  
  counts_i <- dat %>% 
    filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
    filter(lat>min(lat_i) & lat<max(lat_i)) %>% 
    group_by(day, release_month) %>% 
    #tally() %>% # Counting number of particles
    summarize(n = sum(vol_particle)) %>% # Counting number of particles weighted by volume
    left_join(dates_days)  %>% 
    rename(Month = release_month, Date = date) %>% 
    mutate(Month = factor(Month, 
                             levels = as.character(seq(2,9))))

  
  plot_i <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month,color=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                ylab("") + 
                theme_minimal() + theme(legend.position = "null",
                axis.text.x=element_blank(),
        axis.title.x=element_blank())
  
  # Add year to upper row
  if(i == "local"){
    plot_i <- plot_i + 
      ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x]))))  
  }
  
  # Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i + 
      ylab(str_to_sentence(paste0(i," box")))
    }
   
  plotlist <- append(plotlist, list(plot_i))
 }
  
  # For outside area: 
  counts_i <- dat %>% 
  filter(lat>outside_lat) %>% 
  group_by(day, release_month) %>% 
  #tally() %>% # Counting number of particles
  summarize(n = sum(vol_particle)) %>% # Counting number of particles weighted by volume
  left_join(dates_days)  %>% 
  rename(Month = release_month, Date = date) %>% 
  mutate(Month = factor(Month, 
                        levels = as.character(seq(2,9))))

    plot_i <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month,color=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                ylab("") + 
                theme_minimal() + theme(legend.position = "null",
                axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
        axis.title.x=element_blank())
    
  # Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i + 
      ylab("Outside")
    }
   
  plotlist <- append(plotlist, list(plot_i))

  
  
  }
}
 
# Add legend to last plot
plot_legend <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month,color=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                ylab("") + 
                theme_minimal() + theme(legend.position = c(0.1,0.7),
                axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
        axis.title.x=element_blank())
  
                
plotlist[[length(plotlist)]] <- plot_legend
 
grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:16),ncol=4,byrow=FALSE),
            left=textGrob("Number of particles scaled by water volume", rot=90))

# grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:16),ncol=4,byrow=FALSE),
#              top=textGrob("Neutral              Sinking"), left=textGrob("Number of particles", rot=90))


```



There is a large degree of variation in residence time of river material in the different subareas, from a day or less to over 300 days (`r figs("residence_time_box", display = "cite")`). Although the longest residence time tended to occur when river volume transport at the release time was low, there was no clear statistical relationship between residence time and volume transport, i.e., increased volume transport does not necessarily lead to faster movement and lower residence time of particles in the subareas. There was on average a higher volume flux in 2019 compared to 2018.          

```{r residence_time_box_vs_volume, fig.cap = residence_time_box, fig.height = 8, fig.width = 9}

# Calculate moving window of water volume transport (from release day and 4 following days)
# Log-transform to reduce influence of outliers?

transport <- transport %>% 
       mutate(transport_movavg = rollapply(transport, width = 5, FUN= mean, align = 'left', fill = NA)) %>%
  mutate(transport_movavg = log(transport_movavg))
  

xlims <- range(transport$transport_movavg, na.rm=T)
ylims <- c(0,334)

plotlist <- list()
  
for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:2){
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))

   for(i in c("local","inner","outer")){
    lon_i <- get(paste0(i,"_box_lon"))
    lat_i <- get(paste0(i,"_box_lat"))
    
    counts_i <- dat %>% 
      filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
      filter(lat>min(lat_i) & lat<max(lat_i)) %>% 
      left_join(transport %>% mutate(release_date = as.character(release_date))) %>%
      group_by(ID, transport_movavg, release_date, release_month) %>% 
      tally() 
    
    plot_i <- ggplot(data=counts_i, aes(x=transport_movavg, y=n)) +
  geom_point(size=0.05, color = "dark grey") +
  #stat_summary(fun = mean, geom="line", colour="dark green") +
  geom_smooth(method="gam", formula = y ~ s(x, bs = "cs"),
              color = "black", se = FALSE) +
  xlim(xlims) + 
  ylim(ylims) + 
  ylab("") +
  theme_minimal() + theme(legend.position = "null",
                          axis.text.x=element_blank(),
                          axis.title.x=element_blank())

        # Add year/run to upper row
  if(i == "local"){
    plot_i <- plot_i +
      ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x]))))
  }

  # Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i +
      ylab(str_to_sentence(paste0(i," box")))
  }

    plotlist <- append(plotlist, list(plot_i))
    } # Box
    
    
  # For outside area: 
  counts_i <- dat %>% 
  filter(lat>outside_lat) %>% 
   left_join(transport %>% mutate(release_date = as.character(release_date))) %>%
      group_by(ID, transport_movavg, release_date, release_month) %>% 
      tally() 

    plot_i <- ggplot(data=counts_i, aes(x=transport_movavg, y=n)) +
  geom_point(size=0.05, color = "dark grey") +
  #stat_summary(fun = mean, geom="line", colour="dark green") +
  geom_smooth(method="gam", formula = y ~ s(x, bs = "cs", k = 4),
              color = "black", se = FALSE) +
  xlim(xlims) + 
  ylim(ylims) + 
  ylab("") +
  theme_minimal() + theme(legend.position = "null",
                          axis.text.x= element_text(angle=90,hjust=1,vjust=0.5),
                          axis.title.x=element_blank())
    
# Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i + 
      ylab("Outside")
    }
   
  plotlist <- append(plotlist, list(plot_i))

    
  } # Run
} # Year
 
grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:16),ncol=4,byrow=FALSE),
            left=textGrob("Residence time (days)", rot=90), bottom=textGrob("Total volume flux (m3/d)"))


```
Residence time per box: Difference between first and last time within box, plotted per release month and run.

```{r residence_time_box, fig.cap = residence_time_box, fig.height = 8, fig.width = 9}

ylims <- c(0,334)

plotlist <- list()

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:3){
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))
    
    for(i in c("local","inner","middle","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      residence_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(ID, release_month) %>% 
        summarise(residence = max(age+1)-min(age)) %>%
        mutate(region = i)
      
      assign(paste0("residence_", i), residence_i)
      rm(residence_i)
    }
      
    # For outside area: 
    residence_outside <- dat %>% 
      filter(lat>outside_lat) %>% 
      group_by(ID, release_month) %>% 
      summarise(residence = max(age+1)-min(age)) %>%
      mutate(region = "outside")
    
    residence_all <- rbind(residence_local, residence_inner, residence_middle, residence_outer, residence_outside)  %>%
      mutate(release_month = factor(release_month, levels=c(2:9)),
             region = factor(region, levels =c("local","inner","middle","outer","outside")))
    
    plot_x <- 
      ggplot(data=residence_all, aes(x=release_month, y=residence, fill=region)) +
      geom_boxplot(size=0.1, outlier.size=0.1) +
      ylim(ylims) + 
      xlab("") + ylab("") +
      theme_classic() + theme(legend.position = "null")
      
    # Legend run to first plot
    if(year == years[1] & x == 1){
      plot_x <- plot_x +
        theme(legend.position = c(.85, .9), legend.title = element_blank(), 
              legend.text = element_text(size = 8))
    }
    
    # Add run to upper row
      if(year == years[1]){
        plot_x <- plot_x +
          ggtitle(run_name_short[x])
      }
      
      # Add year to left column
      if(x == 1){
        plot_x <- plot_x +
          ylab(year)
      }
      
      plotlist <- append(plotlist, list(plot_x))
  } # Run
} # Year

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:6),ncol=3,byrow=TRUE),
             left=textGrob("Residence time (days)", rot=90), bottom=textGrob("Release month"))


```

Time to reach box: First day within box, plotted per release month and particle type

```{r time_to_reach_box, fig.cap = residence_time_box, fig.height = 8, fig.width = 9}

ylims <- c(0,334)

plotlist <- list()

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:3){
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))
    
    for(i in c("inner","middle","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      firstday_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(ID, release_month) %>% 
        summarise(firstday = min(age)) %>%
        mutate(region = i)
      
      assign(paste0("firstday_", i), firstday_i)
      rm(firstday_i)
    }
      
    # For outside area: 
    firstday_outside <- dat %>% 
      filter(lat>outside_lat) %>% 
      group_by(ID, release_month) %>% 
      summarise(firstday = min(age)) %>%
      mutate(region = "outside")
    
    firstday_all <- rbind(firstday_inner, firstday_middle,
                           firstday_outer, firstday_outside)  %>%
      mutate(release_month = factor(release_month, levels=c(2:9)),
             region = factor(region, levels =c("inner","middle","outer","outside")))
    
    plot_x <- 
      ggplot(data=firstday_all, aes(x=release_month, y=firstday, fill=region)) +
      geom_boxplot(size=0.1, outlier.size=0.1) +
      ylim(ylims) + 
      xlab("") + ylab("") +
      theme_classic() + theme(legend.position = "null")
      
    # Legend run to first plot
    if(year == years[1] & x == 1){
      plot_x <- plot_x +
        theme(legend.position = c(.85, .9), legend.title = element_blank(), 
              legend.text = element_text(size = 8))
    }
    
    # Add run to upper row
      if(year == years[1]){
        plot_x <- plot_x +
          ggtitle(run_name_short[x])
      }
      
      # Add year to left column
      if(x == 1){
        plot_x <- plot_x +
          ylab(year)
      }
      
      plotlist <- append(plotlist, list(plot_x))
  } # Run
} # Year

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:6),ncol=3,byrow=TRUE),
             left=textGrob("Time to reach area (days)", rot=90), bottom=textGrob("Release month"))


```


% of particles present per box per month of simulation (1st day of month)
```{r perc_within_box}


for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:3){
    dat <- get(paste0(runs[x],"_",timespan,"_dat")) %>%
        mutate(year = year(date), month = month(date), month_day = day(date))  %>% 
        filter(month_day == 1 & month > 2)
    
    count_all <- dat %>% 
        group_by(year, month) %>% 
        tally() 
    
    for(i in c("local","inner","middle","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      count_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(year, month) %>% 
        tally() %>%
        rename(!!i:= n)
      
      count_all <- count_all  %>%
        left_join(count_i)

      rm(count_i)
    }
      
    # For outside area: 
    count_outside <- dat %>% 
      filter(lat>outside_lat) %>% 
              group_by(month) %>% 
        tally() %>%
        rename(outside =n) 
    
    count_all <- count_all %>%
        left_join(count_outside) %>%
      mutate(across(c("local":"outside"),
           .fns = ~round(./n,2)))
    
    rm(count_outside)
    
    assign(paste0("perc_", run_name_short[x],"_",year), count_all)
    rm(count_all)
  } # Run
} # Year


all_perc <- bind_cols(bind_rows(perc_Dissolved_2018, perc_Dissolved_2019), 
                      bind_rows(perc_Mud_2018[,-c(1:3)], perc_Mud_2019[,-c(1:3)]), 
                      bind_rows(perc_Sand_2018[,-c(1:3)], perc_Sand_2019[,-c(1:3)]))

tab <- flextable(all_perc) %>% 
  set_header_labels(values = c("Year","Month","N",rep(c("Local","Inner","Middle","Outer","Outside"),3)))  %>% 
  add_header_row(values = c("", "Dissolved", "Mud", "Sand"),  colwidths = c(3, 5, 5, 5))  %>% 
  colformat_num(j = 1,  big.mark = "") %>% 
  vline(j = c(3,8,13))  %>% 
  hline(i = 10) %>% 
  rotate(j=1,rotation="btlr") %>% 
  merge_v(j = 1)   %>% 
  align(align = "center", part = "header")

tab

```


```{r age_particles_day, fig.cap = age_particles_day, fig.height = 11, fig.width = 9,eval=FALSE}

days <- firstDayMonth(unique(dat_sp$date))[seq(2,10,by=2)]

plotlist <- list()

for(x in 1:2){
  if(x == 1){zlims <- c(0,250)} else {
    zlims <- c(0,250)
  }
 dat <- get(paste0(runs[x],"_",timespan,"_dat"))
 dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)

  for(i in 1:length(days)){
    dat_i <- dat_sp[dat_sp$date==days[i],]
    rasterNumParts <- rasterize(x=dat_i[,"age"], y=fullRaster, fun=mean)
    rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    maxval <- max(rasterNumParts$age)

    dayplot <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=age)) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    ggtitle(paste0(days[i], "\nMax: ", maxval)) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          plot.margin = unit(c(-2,0,-0.5,0), "lines"),
          plot.title=element_text(margin=margin(t=40,b=-30)),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
    
    plotlist <- append(plotlist, list(dayplot)) 
  
  }
   lastplot <- ggmap(maparea_zoom) +
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=age)) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"), name="Age (days)") +
    theme(legend.direction = "horizontal") 

  legend <- cowplot::get_legend(lastplot)
  plotlist <- append(plotlist, list(legend))
}


grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:12),ncol=2,byrow=FALSE),
             top=textGrob("Neutral              Sinking"))

```


# Discussion

# Acknowledgements

# Supplemental figures
To assess if releasing 100 particles per day is sufficient to capture the general distribution patterns, we compared results for the 2018-simulation with neutrally buoyant particles to a run with 10 particles released per day. Increasing the number of particles released per day from 10 to 100 leads to a smoother cumulative distribution of river material in the fjord system and a larger total extent of material into the outside area, but the main patterns remain the same.   

```{r compare_particle_number, fig.height = 7, fig.width = 7}
# Comparing runs with 10 and 100 particles released per day (total 2420 vs. 24 200) 
year <- 2018
timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
runs<-c("neutralParticles_10pertimestep","neutralParticles")

for(i in 1:2){
  run_name <- paste0(runs[i],"_",timespan)
  resultfile <- paste0("../results/",run_name,".nc")
  DriftFile <- nc_open(resultfile, write=FALSE) #for nc
  #print(DriftFile)
  #id  <- ncvar_get(DriftFile, 'trajectory')  # Particle ID
  #Create vector of timesteps in days:
  timesteps  <- ncvar_get(DriftFile, 'time')  # seconds since 1970-01-01 00:00:00 
  dates <- as.Date(as.POSIXct(timesteps, origin="1970-01-01"))
  
  days_timestep<-diff(timesteps)[1]/(60*60*24) #days per timestep
  timesteps_days<-rep(NA,length(timesteps));timesteps_days[1]<-days_timestep 
  for (j in 2:length(timesteps_days)){timesteps_days[j]<-timesteps_days[j-1]+days_timestep}
  timesteps_days_rounded<-ceiling(timesteps_days)

  dates_days <- data.frame(day=timesteps_days_rounded,date=dates)
    assign(paste0("dates_days", year), dates_days)
  
  #Extract relevant variables
  status <- ncvar_get(DriftFile, 'status')    #0=active,<0=stranded/not yet released
  release_month <- ncvar_get(DriftFile, 'origin_marker');release_month[status<0]<-NA
  lon <- ncvar_get(DriftFile, 'lon');lon[status<0]<-NA
  lat <- ncvar_get(DriftFile, 'lat');lat[status<0]<-NA
  depth <- ncvar_get(DriftFile, 'z');depth[status<0]<-NA
  age_seconds <- ncvar_get(DriftFile, 'age_seconds');age_seconds[status<0]<-NA
  age_days <- floor(age_seconds/(60*60*24))
  bottom_depth <- ncvar_get(DriftFile, 'sea_floor_depth_below_sea_level');bottom_depth[status<0]<-NA
  
  nc_close(DriftFile)
  
  # Make dataframe of relevant variables
  dayvector <- rep(timesteps_days_rounded, each = dim(release_month)[2])
  datevector <- rep(dates, each = dim(release_month)[2])
  
  dat <- pivot_longer(as.data.frame(release_month), cols= 1:dim(release_month)[2], values_to = "release_month", names_to = "ID")  %>%
        mutate(day=dayvector)  %>%
        mutate(date=datevector)  %>%
        mutate(age=c(t(age_days)))  %>%
        mutate(lon=c(t(lon)))  %>%
        mutate(lat=c(t(lat)))  %>%
        mutate(depth=c(t(depth)))   %>%
        filter(!is.na(release_month))
    
  assign(paste0(run_name,"_dat"), dat)
  
  rm(resultfile, DriftFile, timesteps, days_timestep, timesteps_days, timesteps_days_rounded, release_month, status, lon, lat, depth, age_seconds, age_days, datevector)
}


# Comparing cumulative particle distribution

plotlist <- list()

for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  
  # Counting the number of particles:
  rasterNumParts <- rasterize(x=dat_sp[,"ID"], y=fullRaster, fun="count")
  rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  rasterNumParts$Number <- rasterNumParts$ID
 
 maxval <- max(rasterNumParts$Number)

 if(x == 1){zlims <- c(0,300)} else {
    zlims <- c(0,3000)
  }
 
  fullmap <- ggmap(maparea_all) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red")) +
    coord_cartesian() +
    #scale_fill_gradientn(colours=topo.colors(500, alpha=0.4), name="Number") +
    geom_rect(aes(xmin = 17.7, xmax = 19.2, ymin =
        min(rasterNumParts$y), ymax = 69.7), color="black",fill=NA) + 
    ggtitle(paste0(year,": ", runs[x],"\nMax: ", round(maxval))) +
    theme(plot.margin = unit(rep(.5, 4), "lines"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

  zoommap <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red")) +
    xlab("Lon (°E)") + ylab("Lat (°N)") +
    theme(plot.margin = unit(rep(.5, 4), "lines"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

  # Comparing mean particle depth:
  plot_dep <- dat %>% 
   filter(age != 0) %>%
   group_by(date) %>% 
   summarise(depth = mean(depth)) %>%
    ggplot(aes(x=date,y=depth)) +
  geom_line()+
  ylim(c(-50, 0 )) +
  ylab("Mean particle depth") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) 
  

plotlist <- append(plotlist, list(fullmap, zoommap, plot_dep)) 
  
rm(dat)
}

grid.arrange(grobs = plotlist, layout_matrix = matrix(c(1:6),nrow=3,byrow=FALSE))


```


# References