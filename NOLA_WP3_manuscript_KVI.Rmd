
```{r settings, include=FALSE}
#rm(list = ls())
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
knitr::opts_chunk$set(fig.retina = 1)

setwd("C:/NOLA-SIS_lokal/NOLA")

# libraries
library(ncdf4)
library(maps)
library(mapdata)
library(ggmap)
library(tidyverse)
library(sp)
library(raster)
#library(captioner)
library(knitr)
library(grid)
library(gridExtra)
library(zoo)
library(flextable)


# Function to find first day of given month
firstDayMonth=function(x)
{           
  x=as.Date(as.character(x))
  day = format(x,format="%d")
  monthYr = format(x,format="%Y-%m")
  y = tapply(day,monthYr, min)
  first=as.Date(paste(row.names(y),y,sep="-"))
}

run_name_short <- c("Dissolved","Sinking")

colorcodes_areas <- c("#FF7F50","#8B8B00","#008B45", "#56B4E9","#DA70D6")


# Map basics
landcol<-"gray91"#"darkslategrey"
oceancol<-"white" #"deepskyblue4"

maparea_all <- ggplot() +
  geom_polygon(data = map_data("worldHires"), aes(x = long, y = lat, group = group), # Change to worldHires later
               colour = landcol, fill = landcol) +
  coord_cartesian(xlim = c(16.1, 21.8), ylim = c(69.2, 70.35) ) + 
  theme(axis.title.x=element_blank(),axis.title.y=element_blank(),
        panel.background=element_rect(fill = oceancol, colour = oceancol),
        panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5)) 


maparea_zoom <- ggplot() +
  geom_polygon(data = map_data("worldHires"), aes(x = long, y = lat, group = group), # Change to worldHires later
               colour = landcol, fill = landcol) +
  coord_cartesian(xlim = c(17.7, 19.2), ylim = c(69.28, 69.7) ) + 
  theme(axis.title.x=element_blank(),axis.title.y=element_blank(),
        panel.background=element_rect(fill = oceancol, colour = oceancol),
        panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5)) 

```


```{r read_opendrift_output, include=FALSE}
years <- c(2018,2020)
runs<-c("neutralParticles","sinkingParticles_-0.0003ms")

for(year in years){
  timespan<-paste0(year,"-1-1-1_to_",year,"-12-31-1")
  
for(i in 1:2){
  run_name <- paste0(runs[i],"_",timespan)
  resultfile <- paste0("../results/",run_name,".nc")
  DriftFile <- nc_open(resultfile, write=FALSE) #for nc
  #print(DriftFile)
  #id  <- ncvar_get(DriftFile, 'trajectory')  # Particle ID
  #Create vector of timesteps in days:
  timesteps  <- ncvar_get(DriftFile, 'time')  # seconds since 1970-01-01 00:00:00 
  dates <- as.Date(as.POSIXct(timesteps, origin="1970-01-01"))
  
  days_timestep<-diff(timesteps)[1]/(60*60*24) #days per timestep
  timesteps_days<-rep(NA,length(timesteps));timesteps_days[1]<-days_timestep 
  for (j in 2:length(timesteps_days)){timesteps_days[j]<-timesteps_days[j-1]+days_timestep}
  timesteps_days_rounded<-ceiling(timesteps_days)

  dates_days <- data.frame(day=timesteps_days_rounded,date=dates)
    assign(paste0("dates_days", year), dates_days)
  
  #Extract relevant variables
  status <- ncvar_get(DriftFile, 'status')    #0=active,<0=stranded/not yet released
  release_month <- ncvar_get(DriftFile, 'origin_marker');release_month[status<0]<-NA
  lon <- ncvar_get(DriftFile, 'lon');lon[status<0]<-NA
  lat <- ncvar_get(DriftFile, 'lat');lat[status<0]<-NA
  depth <- ncvar_get(DriftFile, 'z');depth[status<0]<-NA
  age_seconds <- ncvar_get(DriftFile, 'age_seconds');age_seconds[status<0]<-NA
  age_days <- floor(age_seconds/(60*60*24))
  bottom_depth <- ncvar_get(DriftFile, 'sea_floor_depth_below_sea_level');bottom_depth[status<0]<-NA
  
  nc_close(DriftFile)
  
  # Make dataframe of relevant variables
  dayvector <- rep(timesteps_days_rounded, each = dim(release_month)[2])
  datevector <- rep(dates, each = dim(release_month)[2])
  
  dat <- pivot_longer(as.data.frame(release_month), cols= 1:dim(release_month)[2], values_to = "release_month", names_to = "ID")  %>%
        mutate(day=dayvector)  %>%
        mutate(date=datevector)  %>%
        mutate(age=c(t(age_days)))  %>%
        mutate(lon=c(t(lon)))  %>%
        mutate(lat=c(t(lat)))  %>%
        mutate(depth=c(t(depth)))   %>%
        mutate(bottom_depth=c(t(bottom_depth)))   %>%
        filter(!is.na(release_month))
    
  # Remove particles after age 150 days drift / end of September - the sinking runs were terminated at day 274) 
  dat <- dat %>%
    filter(age<=150) %>%
    filter(day<274) 

  assign(paste0(run_name,"_dat"), dat)
  rm(resultfile, DriftFile, timesteps, days_timestep, timesteps_days, timesteps_days_rounded, release_month, status, lon, lat, depth, age_seconds, age_days, datevector)
}

}


```

```{r read_river_file, include=FALSE}
RiverFile <- nc_open(paste0("../NorKyst_files/norfjords_160m_river.nc"), write=FALSE) #for nc
#print(RiverFile)
river_num <- ncvar_get(RiverFile, 'river')  # river number
timesteps_river <- ncvar_get(RiverFile, 'river_time')  # days since 1948-01-01 00:00:00 
dates_river <- as.Date(timesteps_river, origin="1948-01-01")

transport <- ncvar_get(RiverFile, 'river_transport') #river runoff vertically integrated mass transport, units: meter3 second-1 (day??)

timespan_min <- paste0(min(years), "-01-01")
timespan_max <- paste0(max(years), "-12-31-1")

dates_sel <- which(dates_river >= timespan_min & dates_river <= timespan_max)

river_sel <- 167 # MÃ¥lselv

transport <- transport[river_sel, dates_sel]
#transport <- transport/1000 #(convert to m3^-1000)

transport <- data.frame(release_date=dates_river[dates_sel], transport=transport)
nc_close(RiverFile)

rm(river_num, timesteps_river, RiverFile, dates_sel, river_sel, dates_river)
```

```{r scale_by_river_volume, include=FALSE}

for(year in years){
  timespan<-paste0(year,"-1-1-1_to_",year,"-12-31-1")
                                
  for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  
 # Full join doesn't work with dates  
  dat_releaseday <- get(paste0(run_name,"_dat")) %>%
    group_by(ID) %>% 
    slice(1)  %>% 
    mutate(release_date = as.character(date)) %>% 
    dplyr::select(c(ID,release_date))

  dat <- get(paste0(run_name,"_dat")) %>%
    mutate(date = as.character(date)) %>%
    left_join(dat_releaseday) %>%
    left_join(transport %>% mutate(release_date = as.character(release_date))) %>%
    mutate(vol_particle = transport/10) %>% # Scaled by 10 particles released per day
    mutate(date = as.Date(date))
  
  assign(paste0(run_name,"_dat"), dat)

  }
}

rm(dat_releaseday)
```

```{r define_boxes, include=FALSE}

local_box_lon = c(18.462861, 18.562647)
local_box_lat = c(69.304173, 69.357645)

adjacent_box_lon = c(18.5627, 19.05)
adjacent_box_lat = c(69.25, 69.357645)

inner_box_lon = c(18.349934, 18.718452)
inner_box_lat = c(69.357645, 69.438920)

outer_box_lon = c(17.823399, 18.718452)
outer_box_lat = c(69.438921, 69.571700)

# Outisde defines north and west of given latitudes (either) 
outside_lon = c(18.76,25)
outside_lat = c(69.571701, 70.1)

#Set resolution 
reso <- c(0.01,0.005)

#Creating raster for full study area (note, reducing full area to remove particles that meet the borders of NorKyst)
i<-1 
dat <- get(paste0(runs[i],"_",timespan,"_dat"))

fullRaster <- raster(resolution = reso, xmn=16.1, xmx=21.8, ymn=69.2, ymx=70.35)

localRaster <- raster(resolution = reso, xmn=min(local_box_lon), xmx=max(local_box_lon), ymn=min(local_box_lat), ymx=max(local_box_lat))


```

### USED FIGURES ###

```{r study_area}
#Plot distribution at release
overview <- maparea_all +
  coord_cartesian(xlim = c(5, 30), ylim = c(59, 72))  +   
  geom_rect(linewidth=1, aes(xmin = 17.4, xmax = 19.25, ymin = 69.25, ymax= 69.7), fill=NA,color="black") 

txtsize <- 5
alphaval <- 0.4

zoomed <- maparea_all +
  coord_cartesian(xlim = c(17.4, 19.25), ylim = c(69.25, 69.7)) + 
  geom_rect(aes(xmin = min(local_box_lon), xmax = max(local_box_lon), ymin = min(local_box_lat), ymax = max(local_box_lat)), alpha=alphaval, fill=colorcodes_areas[1]) +
  geom_text(aes(x = min(local_box_lon)-0.1, y = mean(local_box_lat), label = "Local"),size = txtsize, vjust = 0, hjust = 0)+
  geom_rect(aes(xmin = min(adjacent_box_lon), xmax = max(adjacent_box_lon), ymin = min(adjacent_box_lat), ymax = max(adjacent_box_lat)), alpha=alphaval, fill=colorcodes_areas[2]) +
  geom_text(aes(x = mean(adjacent_box_lon)-0.1, y = mean(adjacent_box_lat), label = "Adjacent"),size = txtsize, vjust = 0, hjust = 0)+
  geom_rect(aes(xmin = min(inner_box_lon), xmax = max(inner_box_lon), ymin = min(inner_box_lat), ymax = max(inner_box_lat)), alpha=alphaval, fill=colorcodes_areas[3]) +
  geom_text(aes(x = min(inner_box_lon), y = max(inner_box_lat-0.04), label = "Inner"),size = txtsize, vjust = 0, hjust = 0) +
  geom_rect(aes(xmin = min(outer_box_lon), xmax = max(outer_box_lon), ymin = min(outer_box_lat), ymax = max(outer_box_lat)), alpha=alphaval, fill=colorcodes_areas[4]) +
  geom_text(aes(x = mean(outer_box_lon)-0.2, y = mean(outer_box_lat), label = "Outer"),size = txtsize, vjust = 0, hjust = 0) +
   geom_rect(aes(xmin = 10, xmax = min(outside_box_lon), ymin = min(outside_box_lat), ymax = max(outside_box_lat)), 
             colour="black", fill=NA, linetype="dashed") +
  #geom_hline(yintercept= outside_lat, linetype="dashed") +
  geom_text(aes(x = min(outer_box_lon)-0.1, y = outside_lat+0.01, label = "Outside"),size = txtsize, vjust = 0, hjust = 0)+
  geom_point(data=dat  %>% filter(day==1),
             aes(x = lon, y = lat), size=0.1,color="black")  +
  geom_text(aes(x = max(local_box_lon), y = min(local_box_lat-0.06), label = "Release area"),size = 4, vjust = 0, hjust = 0) +
  geom_segment(aes(x = max(local_box_lon)+0.03, y = min(local_box_lat)-0.03, xend = mean(local_box_lon)+0.01, yend = min(local_box_lat)-0.002),
               arrow = arrow(length = unit(0.2, "cm")))

study_area <- overview + annotation_custom(ggplotGrob(zoomed), xmin = 15, xmax = 31, 
                       ymin = 58.5, ymax = 67)

ggsave(study_area, file="../Figures/study_area.jpg", width = 180, height = 160, units = "mm", dpi = 300)

```


Total volume flux, vertical distribution of particles and percentage of particles within each area (weighted by volume flux).


```{r vol_and_dist}

txtsize <- 6
plotlist <- list() 

for(year in years){
  timespan<-paste0(year,"-1-1-1_to_",year,"-12-31-1")
  # Get dates for year:
  dat <- get(paste0(runs[1],"_",timespan,"_dat")) 
  
  transport_y <- transport  %>%
    filter(release_date >= min(dat$date) & release_date <=  max(dat$date)) %>%
    mutate(day = as.numeric(format(release_date, "%j")))
  
# Total river volume
   plot_vol <- ggplot(data=transport_y, aes(x=day, y=transport)) +
     geom_bar(stat="identity", fill ="black", width = 0.5) +
     ylim(c(0,1220)) +
     ylab("Total vol. flux (m3/d)") + xlab("Day") +
     ggtitle(year) +
     theme_classic() + 
     theme(text=element_text(size=txtsize), axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) + xlab("") 
   
   plotlist <- append(plotlist, list(plot_vol)) 

   for(x in 1:2){
    dat <- get(paste0(runs[x],"_",timespan,"_dat")) %>%
        mutate(year = year(date), month = month(date), month_day = day(date))  %>% 
      # Fixing issue with some particles jumping to the surface/getting bottom depth 0 for silt particles
        mutate(bottom_depth = na_if(bottom_depth, 0)) %>%
        mutate(depth = ifelse(is.na(bottom_depth), NA, depth))
       
  # Plot absolute depth and bottom depth:
  # dep_day <- dat %>% 
  #   filter(!is.na(depth)) %>% 
  #   group_by(month,day) %>%  
  #   summarise(lower_dep = quantile(depth, c(0.25)),
  #             med_dep = quantile(depth, c(0.5)),
  #             upper_dep = quantile(depth, c(0.75)))
  # 
  # bottom_day <- dat %>% 
  #   group_by(day) %>%  
  #   filter(!is.na(bottom_depth)) %>% 
  #   summarise(lower_dep = quantile(-bottom_depth, c(0.25)),
  #             med_dep = quantile(-bottom_depth, c(0.5)),
  #             upper_dep = quantile(-bottom_depth, c(0.75)))  %>% 
  #   filter(day != 1)
  # 
  #  plot_dep <- ggplot()  + 
  #     geom_ribbon(dat=dep_day, aes(x=day, ymin=lower_dep, ymax=upper_dep) ,alpha = 0.2) +
  #     geom_line(dat=dep_day, aes(x=day, y=med_dep)) + 
  #     coord_cartesian(ylim = c(-130, 0)) +
  #     # Add bottom depth
  #     geom_line(dat = bottom_day, aes(x=day, y= med_dep), col = "red") + 
  #     ggtitle(run_name_short[x]) +
  #     theme_minimal() +
  #     theme(text=element_text(size=txtsize), axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
  #               axis.title.y.right = element_text(color = "red")) +
  #    xlab("Day of simulation") + ylab("Particle depth / bottom depth") 
     
     # Plot % of particles present per box per month of simulation (1st day of month), scaled up by volume 
     dat <- dat  %>% 
       filter(month_day == 15) 
   
    count_all <- dat %>% 
        group_by(month) %>% 
        summarise(tot_vol = sum(transport))
        #tally() 
    
    for(i in c("local","adjacent","inner","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      count_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(month) %>% 
        #tally() %>%
        summarise(vol_i = sum(transport)) %>% 
        rename(!!i:= vol_i)
      
      count_all <- count_all  %>%
        left_join(count_i)

      rm(count_i)
    }
      
    # For outside area: 
    count_outside <- dat %>% 
     # filter(lat>min(outside_lat) & lon<min(outside_lon) | lat>max(outside_lat) & lon<max(outside_lon)) %>% 
      filter(lat>min(outside_lat)) %>% 
              group_by(month) %>% 
        summarise(vol_i = sum(transport)) %>% 
        #tally() %>%
        rename(outside = vol_i) 
    
    count_all <- count_all %>%
        left_join(count_outside) %>%
      mutate(across(c("local":"outside"),
           .fns = ~round(100*./tot_vol,2)))
    
    rm(count_outside)
    
    plot_perc <-  count_all  %>%
      dplyr::select(-"tot_vol") %>%
      pivot_longer(cols = !month,
                      names_to = "Area",
                      values_to = "Fraction") %>%    
      mutate(Area = factor(Area, levels =c("local","adjacent","inner","outer","outside"))) %>%
      ggplot(aes(month, Fraction)) +   
      geom_bar(aes(fill = Area), position = "dodge", stat="identity") + 
      scale_fill_manual(values=colorcodes_areas) + 
      scale_x_continuous(breaks = seq(1,9))  + 
      ylim(c(0,85)) +
      xlab("Month") + ylab("Percentage in area") +
      ggtitle(run_name_short[x]) +
      theme_classic() + theme(text=element_text(size=txtsize), legend.position = "null")
      
    # Add legend
    if(year == years[1] & x ==1){
      plot_perc <- plot_perc +
  theme(legend.position = c(.6, .9), legend.title = element_blank(), 
        legend.text = element_text(size = 6), legend.direction = "horizontal", legend.key.size = unit(0.4, 'cm'))
    }

 plotlist <- append(plotlist, list(plot_perc)) 
} # Run
} # Year 
     

vol_and_dist <- grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:6),ncol=2,byrow=FALSE))

ggsave(vol_and_dist, file="../Figures/vol_and_dist.jpg", width = 180, height = 180, units = "mm", dpi = 300)


```

Residence time per box (Difference between first and last time within box) and time to reach area, plotted per release month and run.

```{r residence_and_time_to_reach_box}

ylims <- c(0,155)
txtsize <- 6

plotlist <- list()

for(year in years){
  timespan<-paste0(year,"-1-1-1_to_",year,"-12-31-1")
  for(x in 1:2){
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))
    
    # Plot time to reach box
    for(i in c("adjacent","inner","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      firstday_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(ID, release_month) %>% 
        summarise(firstday = min(age)) %>%
        mutate(region = i)
      
      assign(paste0("firstday_", i), firstday_i)
      rm(firstday_i)
    }
      
    # For outside area: 
    firstday_outside <- dat %>% 
      filter(lat>min(outside_lat)) %>% 
      group_by(ID, release_month) %>% 
      summarise(firstday = min(age)) %>%
      mutate(region = "outside")
    
    firstday_all <- rbind(firstday_adjacent, firstday_inner,
                           firstday_outer, firstday_outside)  %>%
      mutate(release_month = factor(release_month, levels=c(1:7)),
             region = factor(region, levels =c("adjacent","inner","outer","outside")))
    
    print(firstday_all %>% 
      group_by(region, release_month) %>% 
      summarise(med_day = median(firstday), max_day = max(firstday)), n=50)
    
    plot_x <- 
      ggplot(data=firstday_all, aes(x=release_month, y=firstday, fill=region)) +
      geom_boxplot(size=0.1, outlier.size=0.1) +
      scale_fill_manual(values=colorcodes_areas[-1]) + 
      ylim(ylims) + 
      xlab("") + ylab("") +
      theme_classic() + theme(legend.position = "null",  text=element_text(size=txtsize))
      
    # Ylab first year
    if(year == years[1]){
      plot_x <- plot_x +
        ylab("Time to reach")
    }
   
    # Year and run to upper row
      if(x == 1){
        plot_x <- plot_x +
           ggtitle(label=year, subtitle = run_name_short[x])
      }
      
    # Run to subsequent rows
      if(x %in% c(2,3)){
        plot_x <- plot_x +
          ggtitle(label=run_name_short[x])
      }
    
    # Legend to first plot
    if(year == years[1] & x == 1){
      plot_x <- plot_x +
        theme(legend.position = c(.6, 1.2), legend.title = element_blank(), 
              legend.text = element_text(size = 6), legend.direction = "horizontal", legend.key.size = unit(0.6, 'cm')) }
    
    plotlist <- append(plotlist, list(plot_x))

     rm(list=ls(pattern="firstday"))
      
    # Plot residence time
    for(i in c("local","adjacent","inner","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      residence_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(ID, release_month) %>% 
        summarise(residence = max(age+1)-min(age)) %>%
        mutate(region = i)
      
      assign(paste0("residence_", i), residence_i)
      rm(residence_i)
    }
      
    # For outside area: 
    residence_outside <- dat %>% 
      filter(lat>min(outside_lat)) %>% 
      group_by(ID, release_month) %>% 
      summarise(residence = max(age+1)-min(age)) %>%
      mutate(region = "outside")
    
    residence_all <- rbind(residence_local, residence_adjacent, residence_inner, residence_outer, residence_outside)  %>%
      mutate(release_month = factor(release_month, levels=c(1:7)),
             region = factor(region, levels =c("local","adjacent","inner","outer","outside")))
    
    plot_x <- 
      ggplot(data=residence_all, aes(x=release_month, y=residence, fill=region)) +
      geom_boxplot(size=0.1, outlier.size=0.1) +
      scale_fill_manual(values=colorcodes_areas) + 
      ylim(ylims) + 
      xlab("") + ylab("") +
      theme_classic() + theme(legend.position = "null", text=element_text(size=txtsize))
   
    # Ylab to first year  
    if(year == years[1]){
      plot_x <- plot_x +
        ylab("Residence time")
    }
    
   
  
     plotlist <- append(plotlist, list(plot_x))
      rm(list=ls(pattern="residence_"))
  } # Run
} # Year

time_and_residence <- grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:8),ncol=2,byrow=FALSE), bottom=textGrob("Release month"))

ggsave(time_and_residence, file="../Figures/time_and_residence.jpg", width = 180, height = 200, units = "mm", dpi = 300)

```

Show example of particle remaining in adjacent area 
```{r single_particle_adjacent_area}
year<-2018
x<-1
timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
dat <- get(paste0(runs[x],"_",timespan,"_dat"))
i<-"inner"
lon_i <- get(paste0(i,"_box_lon"))
lat_i <- get(paste0(i,"_box_lat"))
firstday_i <- dat %>% 
         filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
         filter(lat>min(lat_i) & lat<max(lat_i)) %>%
         group_by(ID, release_month) %>% 
         summarise(firstday = min(age)) %>%
         mutate(region = i)
view(firstday_i)


id_x <-  "V10543"
test <- dat  %>%
  filter(ID== id_x) 

anim <- ggplot(data=test,aes(x = lon, y = lat), size=0.1) +
  geom_point() +
  labs(title = 'Time (days): {frame_time}') +
  transition_time(age) 

# anim <- maparea_all +
#   coord_cartesian(xlim = c(17.4, 19.25), ylim = c(69.25, 69.7)) + 
#   geom_point(data=test,
#              aes(x = lon, y = lat), size=0.1)  +
#   labs(title = 'Time (days): {frame_time}') +
#   transition_time(age) 

animate(anim, duration = 20, width = 600, height = 600, renderer = gifski_renderer(loop=FALSE))
anim_save(file=paste0("../Figures/",id_x,".gif"))

```


For the upper area. Removed outer area


Time to reach box: First day within box, plotted per release month and particle type




## OLD STUFF ##
```{r particle_depth, eval=FALSE}

plotlist <- list()

for(x in 1:3){
    for(year in years){
      # Combine data from 2018 and 2019
      run_name <- paste0(runs[x],"_","2018-2-1-1_to_2018-12-31-1")
      dat_2018 <- get(paste0(run_name,"_dat")) 
      
      run_name <- paste0(runs[x],"_","2019-2-1-1_to_2019-12-31-1")
      dat_2019 <- get(paste0(run_name,"_dat")) 
    
      # Fixing issue with some particles jumping to the surface/getting bottom depth 0 for silt particles
      dat_comb <- rbind(dat_2018, dat_2019) %>% 
        filter(age != 0) %>%
        mutate(bottom_depth = na_if(bottom_depth, 0)) %>%
        mutate(depth = ifelse(is.na(bottom_depth), NA, depth))
      
    }
      # Plot absolute depth:
      plot_dep <- dat_comb  %>% 
        ggplot(aes(x=day, y=depth))+ 
    # Plot mean + confidence interval:
    # stat_summary(geom="ribbon", fun.data=mean_cl_normal, fill="grey")+
    # stat_summary(geom="line", fun=mean)+
   # Plot median + upper/lower quantiles:
        stat_summary(geom="ribbon", fun.min = function(x) quantile(x, 0.25), fun.max = function(x) quantile(x, 0.75), fill = "light grey") + ylab("") +
    stat_summary(geom="line", fun=median)+
    coord_cartesian(ylim = c(-130, 0)) +
    theme_minimal() +
    theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
    ggtitle(run_name_short[x])

    if(x == 1){
    plot_dep <- plot_dep + ylab("Median depth distribution") 
    }

    # Plot relative depth:
      plot_relative_dep <- dat_comb  %>% 
      mutate(relative_depth = round(100*(abs(depth)/bottom_depth)))  %>%
      mutate(relative_depth=replace(relative_depth, relative_depth > 100,100))  %>%
    ggplot(aes(x=day, y=relative_depth))+ 
   # Plot mean + confidence interval:
    # stat_summary(geom="ribbon", fun.data=mean_cl_normal, fill="grey")+
    # stat_summary(geom="line", fun=mean)+
   # Plot median + upper/lower quantiles:
   stat_summary(geom="ribbon", fun.min = function(x) quantile(x, 0.25), fun.max = function(x) quantile(x, 0.75), fill = "light grey") + 
    stat_summary(geom="line", fun=median)+
     coord_cartesian(ylim = c(100, 0)) +  ylab("") +
    theme_minimal() +
    theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) 

    if(x == 1){
    plot_relative_dep <- plot_relative_dep + ylab("Relative depth distribution") 
    }

    plotlist <- append(plotlist, list(plot_dep, plot_relative_dep)) 
  }

grid.arrange(grobs = plotlist, ncol = 3, as.table = FALSE)  

```

% of particles present per box per month of simulation (1st day of month)
```{r perc_within_box, eval=FALSE}

plotlist <- list() 

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:3){
    dat <- get(paste0(runs[x],"_",timespan,"_dat")) %>%
      mutate(year = year(date), month = month(date), month_day = day(date))  %>% 
      filter(month_day == 1 & month > 2) 
    
    count_all <- dat %>% 
        group_by(month) %>% 
        tally() 
    
    for(i in c("local","adjacent","inner","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      count_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(month) %>% 
        tally() %>%
        rename(!!i:= n)
      
      count_all <- count_all  %>%
        left_join(count_i)

      rm(count_i)
    }
      
    # For outer area: 
    count_outer <- dat %>% 
      filter(lat>min(outer_box_lat) & lon<min(outer_box_lon) | lat>max(outer_box_lat) & lon<max(outer_box_lon)) %>% 
              group_by(month) %>% 
        tally() %>%
        rename(outer =n) 
    
    count_all <- count_all %>%
        left_join(count_outer) %>%
      mutate(across(c("local":"outer"),
           .fns = ~round(100*./n,2)))
    
    rm(count_outer)
    
    plot_x <-  count_all  %>%
      dplyr::select(-"n") %>%
      pivot_longer(cols = !month,
                      names_to = "Area",
                      values_to = "Fraction") %>%    
      mutate(Area = factor(Area, levels =c("local","adjacent","inner","outer","outer"))) %>%
      ggplot(aes(month, Fraction)) +   
      geom_bar(aes(fill = Area), position = "dodge", stat="identity") + 
      scale_x_continuous(breaks = seq(3,12))  + 
      xlab("") + ylab("") +
      theme_classic() + theme(legend.position = "null")
      
    # Legend to last plot
    if(year == years[2] & x == 3){
      plot_x <- plot_x +
        theme(legend.position = c(.85, .9), legend.title = element_blank(), 
              legend.text = element_text(size = 8))
    }
    
    # Add run to upper row
      if(year == years[1]){
        plot_x <- plot_x +
          ggtitle(run_name_short[x])
      }
      
      # Add year to left column
      if(x == 1){
        plot_x <- plot_x +
          ylab(year)
      }
      
      plotlist <- append(plotlist, list(plot_x))

    # count_all  <- count_all %>%
    #   mutate(year = year) %>%
    #   relocate(year, .before = month)
    # 
    # assign(paste0("perc_", run_name_short[x],"_",year), count_all)
    
    rm(count_all)
  } # Run
} # Year

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:6),ncol=3,byrow=TRUE),
             left=textGrob("Percentage in area", rot=90), bottom=textGrob("Month"))

# Create table
# all_perc <- bind_cols(bind_rows(perc_Dissolved_2018, perc_Dissolved_2019), 
#                       bind_rows(perc_Clay_2018[,-c(1:3)], perc_Clay_2019[,-c(1:3)]), 
#                       bind_rows(perc_Sand_2018[,-c(1:3)], perc_Sand_2019[,-c(1:3)]))
# 
# tab <- flextable(all_perc) %>% 
#   set_header_labels(values = c("Year","Month","N",rep(c("Local","Adjacent","Inner","inner","outer"),3)))  %>% 
#   add_header_row(values = c("", "Dissolved", "Clay", "Sand"),  colwidths = c(3, 5, 5, 5))  %>% 
#   colformat_num(j = 1,  big.mark = "") %>% 
#   vline(j = c(3,8,13))  %>% 
#   hline(i = 10) %>% 
#   rotate(j=1,rotation="btlr") %>% 
#   merge_v(j = 1)   %>% 
#   align(align = "center", part = "header")
# 
# tab

```


Cumulatively over the course of the year (February to December), material originating from the MÃ¥lselv river is distributed throughout the Malangen fjord system, into the Norwegian Sea and north along the Norwegian coast (`r figs("num_particles", display = "cite")`). The highest concentration of material originating from the river is found locally along the eastern coast of inner fjord area, in addition to within the release area (where all river water passes through initially, `r figs("num_particles", display = "cite")`). Comparing neutrally buoyant and sinking material, a higher fraction of the sinking material is kept within the inner fjord system, while much of the neutrally buoyant material is spread throughout and outer the study system.   

```{r time_to_reach_box, eval=FALSE}

ylims <- c(0,334)

plotlist <- list()

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:3){
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))
    
    for(i in c("adjacent","inner","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      firstday_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(ID, release_month) %>% 
        summarise(firstday = min(age)) %>%
        mutate(region = i)
      
      assign(paste0("firstday_", i), firstday_i)
      rm(firstday_i)
    }
      
    # For outer area: 
    firstday_outer <- dat %>% 
      filter(lat>outer_lat) %>% 
      group_by(ID, release_month) %>% 
      summarise(firstday = min(age)) %>%
      mutate(region = "outer")
    
    firstday_all <- rbind(firstday_adjacent, firstday_inner,
                           firstday_outer, firstday_outer)  %>%
      mutate(release_month = factor(release_month, levels=c(2:9)),
             region = factor(region, levels =c("adjacent","inner","outer","outer")))
    
    plot_x <- 
      ggplot(data=firstday_all, aes(x=release_month, y=firstday, fill=region)) +
      geom_boxplot(size=0.1, outlier.size=0.1) +
      ylim(ylims) + 
      xlab("") + ylab("") +
      theme_classic() + theme(legend.position = "null")
      
    # Legend run to first plot
    if(year == years[1] & x == 1){
      plot_x <- plot_x +
        theme(legend.position = c(.85, .9), legend.title = element_blank(), 
              legend.text = element_text(size = 8))
    }
    
    # Add run to upper row
      if(year == years[1]){
        plot_x <- plot_x +
          ggtitle(run_name_short[x])
      }
      
      # Add year to left column
      if(x == 1){
        plot_x <- plot_x +
          ylab(year)
      }
      
      plotlist <- append(plotlist, list(plot_x))
  } # Run
} # Year

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:6),ncol=3,byrow=TRUE),
             left=textGrob("Time to reach area (days)", rot=90), bottom=textGrob("Release month"))


```

```{r time_to_reach_box_upper, fig.cap = residence_time_box, fig.height = 8, fig.width = 9}
deplim <- -10

ylims <- c(0,300)

# Function to count the number of data points
n_fun <- function(x){
    return(data.frame(y = max(ylims),
                      label = length(x)))
}

plotlist <- list()

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:3){
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))
    
    for(i in c("adjacent","inner","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      firstday_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(ID) %>% 
        mutate(firstday = min(age), days_below_deplim = sum(depth < deplim))  %>%
        filter(days_below_deplim == 0) %>%
        mutate(region = i)
      
      assign(paste0("firstday_", i), firstday_i)
      rm(firstday_i)
    }
      
     firstday_all <- rbind(firstday_inner, firstday_inner,
                           firstday_outer)  %>%
      mutate(region = factor(region, levels =c("inner","inner","outer")))
    
    plot_x <- 
      ggplot(data=firstday_all, aes(x=region, y=firstday, fill=region)) +
      geom_boxplot(size=0.1, outlier.size=0.1) +
      stat_summary(fun.data = n_fun, geom = "text", hjust = 0.5,
                  position = position_dodge(width = 0.8)) +
      ylim(ylims) + 
      xlab("") + ylab("") +
      theme_classic() + theme(legend.position = "null")
      
    # Legend run to first plot
    if(year == years[1] & x == 1){
      plot_x <- plot_x +
        theme(legend.position = c(.15, .75), legend.title = element_blank(), 
              legend.text = element_text(size = 8))
    }
    
    # Add run to upper row
      if(year == years[1]){
        plot_x <- plot_x +
          ggtitle(run_name_short[x])
      }
      
      # Add year to left column
      if(x == 1){
        plot_x <- plot_x +
          ylab(year)
      }
      
      plotlist <- append(plotlist, list(plot_x))
  } # Run
} # Year

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:6),ncol=3,byrow=TRUE),
             left=textGrob("Time to reach area (days)", rot=90))

# Summarized for Maeve
i <- "outer"
lon_i <- get(paste0(i,"_box_lon"))
lat_i <- get(paste0(i,"_box_lat"))
    
for(x in 1:3){
    print(run_name_short[x])
for(year in years){
    timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))

    firstday_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(ID) %>% 
        mutate(firstday = min(age), days_below_deplim = sum(depth < deplim))  %>%
        filter(days_below_deplim == 0)
    
    print(year)
    print(summary(firstday_i$firstday))
    
    }
}
    

```

```{r residence_time_box, eval=FALSE}

ylims <- c(0,334)

plotlist <- list()

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:3){
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))
    
    for(i in c("local","inner","inner","outer")){
      lon_i <- get(paste0(i,"_box_lon"))
      lat_i <- get(paste0(i,"_box_lat"))
      
      residence_i <- dat %>% 
        filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
        filter(lat>min(lat_i) & lat<max(lat_i)) %>%
        group_by(ID, release_month) %>% 
        summarise(residence = max(age+1)-min(age)) %>%
        mutate(region = i)
      
      assign(paste0("residence_", i), residence_i)
      rm(residence_i)
    }
      
    # For outer area: 
    residence_outer <- dat %>% 
      filter(lat>min(outer_box_lat) & lon<min(outer_box_lon) | lat>max(outer_box_lat) &
                  lon<max(outer_box_lon)) %>% 
      group_by(ID, release_month) %>% 
      summarise(residence = max(age+1)-min(age)) %>%
      mutate(region = "outer")
    
    residence_all <- rbind(residence_local, residence_inner, residence_inner, residence_outer, residence_outer)  %>%
      mutate(release_month = factor(release_month, levels=c(2:9)),
             region = factor(region, levels =c("local","inner","inner","outer","outer")))
    
    plot_x <- 
      ggplot(data=residence_all, aes(x=release_month, y=residence, fill=region)) +
      geom_boxplot(size=0.1, outlier.size=0.1) +
      ylim(ylims) + 
      xlab("") + ylab("") +
      theme_classic() + theme(legend.position = "null")
      
    # Legendto first plot
    if(year == years[1] & x == 1){
      plot_x <- plot_x +
        theme(legend.position = c(.85, .9), legend.title = element_blank(), 
              legend.text = element_text(size = 8))
    }
    
    # Add run to upper row
      if(year == years[1]){
        plot_x <- plot_x +
          ggtitle(run_name_short[x])
      }
      
      # Add year to left column
      if(x == 1){
        plot_x <- plot_x +
          ylab(year)
      }
      
      plotlist <- append(plotlist, list(plot_x))
  } # Run
} # Year

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:6),ncol=3,byrow=TRUE),
             left=textGrob("Residence time (days)", rot=90), bottom=textGrob("Release month"))


```

```{r num_particles, eval=FALSE}

cols_order <- c("thistle","purple","blue","green","yellow","orange","red","dark red","black")
plotlist <- list()
zlims <- c(0,15000)

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")

for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  
  # Counting the number of particles:
  # rasterNumParts <- rasterize(x=dat_sp[,"ID"], y=fullRaster, fun="count")
  # rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  #rasterNumParts$Number <- rasterNumParts$ID
 
  # Summing the volume of particles:
  rasterNumParts <- rasterize(x=dat_sp[,"vol_particle"], y=fullRaster, fun="sum")
  rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  rasterNumParts$Number <- rasterNumParts$vol_particle
  
 maxval <- max(rasterNumParts$Number)
 #zlims <- c(0, quantile(rasterNumParts$Number, 0.9999))

  fullmap <- maparea_all + 
  geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
  scale_fill_gradientn(limits = zlims,
                       na.value = "red", #na.value color same as color for max value
                       colours = cols_order) +
  #scale_fill_gradientn(colours=topo.colors(500, alpha=0.4), name="Number") +
  geom_rect(aes(xmin = 17.7, xmax = 19.2, ymin =
                  min(rasterNumParts$y), ymax = 69.7), color="black",fill=NA) + 
  ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x])),
                 "\nMax: ", round(maxval))) +
  theme(legend.position = c(0.85, 0.25), legend.title = element_blank(),
        legend.key.width=unit(3,"mm"),legend.background=element_blank(),
        plot.margin = unit(rep(.5, 4), "lines"),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

 zoommap <- maparea_zoom + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = cols_order) +
    xlab("Lon (Â°E)") + ylab("Lat (Â°N)") +
    theme(legend.position = "none", 
          plot.margin = unit(rep(.5, 4), "lines"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.border = element_rect(colour = "black", fill=NA))

plotlist <- append(plotlist, list(fullmap, zoommap)) 
  
rm(dat)
}
}

grid.arrange(grobs = plotlist, layout_matrix = matrix(c(1:8),nrow=2,byrow=FALSE))

```
  
Comparing the distribution of material originating from the river at the first day of every 2nd month during the simulation, the highest concentrations of river material is found in the inner fjord system from July and onward (`r figs("num_particles_day", display = "cite")`), corresponding to the period after the strongest river volume flow (`r figs("particle_release", display = "cite")`). The river water transport before May was stronger in 2019 compared to 2018 (`r figs("particle_release", display = "cite")`), which is reflected in higher concentrations of river material in the inner system in this year in May  (`r figs("num_particles_day", display = "cite")`).  *This figure could be moved to the supplementary material and potentially replaced by an animation.*  

```{r num_particles_day, eval=FALSE}

# `r figs("num_particles_day", display = "cite")` shows the distribution of water at the first day of each month of the simulation. *This figure could be moved to the supplementary material and potentially replaced by an animation.*  

plotlist <- list()
zlims <- c(0,7.4)

for(x in 1:3){
  for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  days <- firstDayMonth(unique(dat_sp$date))[c(3,5,7,9)]

  for(i in 1:length(days)){
    dat_i <- dat_sp[dat_sp$date==days[i],]
    # Counting the number of particles:
    # rasterNumParts <- rasterize(x=dat_i[,"ID"], y=fullRaster, fun="count")
    # rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    # maxval <- max(rasterNumParts$ID)
    
    # Summing the volume of particles:
    rasterNumParts <- rasterize(x=dat_i[,"vol_particle"], y=fullRaster, fun="sum")
    rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    rasterNumParts$Number <- log(rasterNumParts$vol_particle+1)
    #maxval <- max(rasterNumParts$Number)

    dayplot <- maparea_all +
      coord_cartesian(xlim = c(17.4, 19.25), ylim = c(69.25, 69.7)) + 
      geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    #ggtitle(paste0(days[i], "\nMax: ", round(maxval))) +
    ggtitle(days[i]) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          plot.margin = unit(c(-2,0,-0.5,0), "lines"),
          plot.title=element_text(face="bold", margin=margin(t=40,b=-20)),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
    
    if(i == 1 & year == 2018){
      dayplot <- dayplot +
           labs(subtitle = run_name_short[x]) + 
        theme(plot.title = element_text(vjust = -3),
              plot.subtitle = element_text(face = "bold", hjust = 0.5))}


    plotlist <- append(plotlist, list(dayplot)) 
  } # Days
  } # Year
} # Run

# Get legend
 lastplot <- maparea_all  +
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"), name="log(Volume)") +
    theme(legend.direction = "horizontal") 

  legend <- cowplot::get_legend(lastplot)
  plotlist <- append(plotlist, list(legend))
 

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:8,NA,9:16,25,17:24,NA),ncol=3,byrow=FALSE), heights = c(rep(1,8),0.5))

```

```{r num_particles_day_upper, eval=FALSE}

# `r figs("num_particles_day", display = "cite")` shows the distribution of water at the first day of each month of the simulation. *This figure could be moved to the supplementary material and potentially replaced by an animation.*  
deplim <- -10

plotlist <- list()
zlims <- c(0,6.5)

for(x in 1:3){
  for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat")) %>%
    filter(depth > deplim)  

  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  days <- firstDayMonth(unique(dat_sp$date))[c(3,5,7,9)]

  for(i in 1:length(days)){
    dat_i <- dat_sp[dat_sp$date==days[i],]
    # Counting the number of particles:
    # rasterNumParts <- rasterize(x=dat_i[,"ID"], y=fullRaster, fun="count")
    # rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    # maxval <- max(rasterNumParts$ID)
    
    # Summing the volume of particles:
    rasterNumParts <- rasterize(x=dat_i[,"vol_particle"], y=fullRaster, fun="sum")
    rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    rasterNumParts$Number <- log(rasterNumParts$vol_particle+1)
    #maxval <- max(rasterNumParts$Number)

    dayplot <- maparea_all +
      coord_cartesian(xlim = c(17.4, 19.25), ylim = c(69.25, 69.7)) + 
      geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    #ggtitle(paste0(days[i], "\nMax: ", round(maxval))) +
    ggtitle(days[i]) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          plot.margin = unit(c(-2,0,-0.5,0), "lines"),
          plot.title=element_text(face="bold", margin=margin(t=40,b=-20)),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
    
    if(i == 1 & year == 2018){
      dayplot <- dayplot +
           labs(subtitle = run_name_short[x]) + 
        theme(plot.title = element_text(vjust = -3),
              plot.subtitle = element_text(face = "bold", hjust = 0.5))}


    plotlist <- append(plotlist, list(dayplot)) 
  } # Days
  } # Year
} # Run

# Get legend
 lastplot <- maparea_all  +
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"), name="log(Volume)") +
    theme(legend.direction = "horizontal") 

  legend <- cowplot::get_legend(lastplot)
  plotlist <- append(plotlist, list(legend))
 

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:8,NA,9:16,25,17:24,NA),ncol=3,byrow=FALSE), heights = c(rep(1,8),0.5))

```

To summarize the distribution of river material through time, `r figs("num_particles_box", display = "cite")` shows the sum of material present within each subarea of the study region (`r figs("study_area", display = "cite")`) per day during the simulation, separated into month of release. Little material is retained within the Local box while a larger fraction is retained within the Inner box, in particular for the sinking material. Material reaching the outer box seem to pass through this area relatively quickly compared to the Inner box. A larger fraction of neutrally buoyant material reaches the outer area (north of the outer box), compared to the sinking material.      

```{r num_particles_box, eval=FALSE}

plotlist <- list()
ylims <- c(0,60000)

for(year in years){
timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:2){
  dat <- get(paste0(runs[x],"_",timespan,"_dat"))
  xlims<-(c(min(dat$date),max(dat$date-1)))
  dates_days <- get(paste0("dates_days",year))
 
 for(i in c("local","inner","outer")){
  lon_i <- get(paste0(i,"_box_lon"))
  lat_i <- get(paste0(i,"_box_lat"))
  
  counts_i <- dat %>% 
    filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
    filter(lat>min(lat_i) & lat<max(lat_i)) %>% 
    group_by(day, release_month) %>% 
    #tally() %>% # Counting number of particles
    summarize(n = sum(vol_particle)) %>% # Counting number of particles weighted by volume
    left_join(dates_days)  %>% 
    rename(Month = release_month, Date = date) %>% 
    mutate(Month = factor(Month, 
                             levels = as.character(seq(2,9))))

  
  plot_i <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month,color=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                ylab("") + 
                theme_minimal() + theme(legend.position = "null",
                axis.text.x=element_blank(),
        axis.title.x=element_blank())
  
  # Add year to upper row
  if(i == "local"){
    plot_i <- plot_i + 
      ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x]))))  
  }
  
  # Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i + 
      ylab(str_to_sentence(paste0(i," box")))
    }
   
  plotlist <- append(plotlist, list(plot_i))
 }
  
  # For outer area: 
  counts_i <- dat %>% 
  filter(lat>outer_lat) %>% 
  group_by(day, release_month) %>% 
  #tally() %>% # Counting number of particles
  summarize(n = sum(vol_particle)) %>% # Counting number of particles weighted by volume
  left_join(dates_days)  %>% 
  rename(Month = release_month, Date = date) %>% 
  mutate(Month = factor(Month, 
                        levels = as.character(seq(2,9))))

    plot_i <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month,color=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                ylab("") + 
                theme_minimal() + theme(legend.position = "null",
                axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
        axis.title.x=element_blank())
    
  # Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i + 
      ylab("outer")
    }
   
  plotlist <- append(plotlist, list(plot_i))

  
  
  }
}
 
# Add legend to last plot
plot_legend <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month,color=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                ylab("") + 
                theme_minimal() + theme(legend.position = c(0.1,0.7),
                axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
        axis.title.x=element_blank())
  
                
plotlist[[length(plotlist)]] <- plot_legend
 
grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:16),ncol=4,byrow=FALSE),
            left=textGrob("Number of particles scaled by water volume", rot=90))

# grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:16),ncol=4,byrow=FALSE),
#              top=textGrob("Neutral              Sinking"), left=textGrob("Number of particles", rot=90))


```



There is a large degree of variation in residence time of river material in the different subareas, from a day or less to over 300 days (`r figs("residence_time_box", display = "cite")`). Although the longest residence time tended to occur when river volume transport at the release time was low, there was no clear statistical relationship between residence time and volume transport, i.e., increased volume transport does not necessarily lead to faster movement and lower residence time of particles in the subareas. There was on average a higher volume flux in 2019 compared to 2018.          

```{r residence_time_box_vs_volume, eval=FALSE}

# Calculate moving window of water volume transport (from release day and 4 following days)
# Log-transform to reduce influence of outliers?

transport <- transport %>% 
       mutate(transport_movavg = rollapply(transport, width = 5, FUN= mean, align = 'left', fill = NA)) %>%
  mutate(transport_movavg = log(transport_movavg))
  

xlims <- range(transport$transport_movavg, na.rm=T)
ylims <- c(0,334)

plotlist <- list()
  
for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:2){
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))

   for(i in c("local","inner","outer")){
    lon_i <- get(paste0(i,"_box_lon"))
    lat_i <- get(paste0(i,"_box_lat"))
    
    counts_i <- dat %>% 
      filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
      filter(lat>min(lat_i) & lat<max(lat_i)) %>% 
      left_join(transport %>% mutate(release_date = as.character(release_date))) %>%
      group_by(ID, transport_movavg, release_date, release_month) %>% 
      tally() 
    
    plot_i <- ggplot(data=counts_i, aes(x=transport_movavg, y=n)) +
  geom_point(size=0.05, color = "dark grey") +
  #stat_summary(fun = mean, geom="line", colour="dark green") +
  geom_smooth(method="gam", formula = y ~ s(x, bs = "cs"),
              color = "black", se = FALSE) +
  xlim(xlims) + 
  ylim(ylims) + 
  ylab("") +
  theme_minimal() + theme(legend.position = "null",
                          axis.text.x=element_blank(),
                          axis.title.x=element_blank())

        # Add year/run to upper row
  if(i == "local"){
    plot_i <- plot_i +
      ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x]))))
  }

  # Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i +
      ylab(str_to_sentence(paste0(i," box")))
  }

    plotlist <- append(plotlist, list(plot_i))
    } # Box
    
    
  # For outer area: 
  counts_i <- dat %>% 
  filter(lat>outer_lat) %>% 
   left_join(transport %>% mutate(release_date = as.character(release_date))) %>%
      group_by(ID, transport_movavg, release_date, release_month) %>% 
      tally() 

    plot_i <- ggplot(data=counts_i, aes(x=transport_movavg, y=n)) +
  geom_point(size=0.05, color = "dark grey") +
  #stat_summary(fun = mean, geom="line", colour="dark green") +
  geom_smooth(method="gam", formula = y ~ s(x, bs = "cs", k = 4),
              color = "black", se = FALSE) +
  xlim(xlims) + 
  ylim(ylims) + 
  ylab("") +
  theme_minimal() + theme(legend.position = "null",
                          axis.text.x= element_text(angle=90,hjust=1,vjust=0.5),
                          axis.title.x=element_blank())
    
# Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i + 
      ylab("outer")
    }
   
  plotlist <- append(plotlist, list(plot_i))

    
  } # Run
} # Year
 
grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:16),ncol=4,byrow=FALSE),
            left=textGrob("Residence time (days)", rot=90), bottom=textGrob("Total volume flux (m3/d)"))


```

```{r age_particles_day, eval=FALSE}

days <- firstDayMonth(unique(dat_sp$date))[seq(2,10,by=2)]

plotlist <- list()

for(x in 1:2){
  if(x == 1){zlims <- c(0,250)} else {
    zlims <- c(0,250)
  }
 dat <- get(paste0(runs[x],"_",timespan,"_dat"))
 dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)

  for(i in 1:length(days)){
    dat_i <- dat_sp[dat_sp$date==days[i],]
    rasterNumParts <- rasterize(x=dat_i[,"age"], y=fullRaster, fun=mean)
    rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    maxval <- max(rasterNumParts$age)

    dayplot <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=age)) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    ggtitle(paste0(days[i], "\nMax: ", maxval)) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          plot.margin = unit(c(-2,0,-0.5,0), "lines"),
          plot.title=element_text(margin=margin(t=40,b=-30)),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
    
    plotlist <- append(plotlist, list(dayplot)) 
  
  }
   lastplot <- ggmap(maparea_zoom) +
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=age)) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"), name="Age (days)") +
    theme(legend.direction = "horizontal") 

  legend <- cowplot::get_legend(lastplot)
  plotlist <- append(plotlist, list(legend))
}


grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:12),ncol=2,byrow=FALSE),
             top=textGrob("Neutral              Sinking"))

```


# Discussion

# Acknowledgements

# Supplemental figures
To assess if releasing 100 particles per day is sufficient to capture the general distribution patterns, we compared results for the 2018-simulation with neutrally buoyant particles to a run with 10 particles released per day. Increasing the number of particles released per day from 10 to 100 leads to a smoother cumulative distribution of river material in the fjord system and a larger total extent of material into the outer area, but the main patterns remain the same.   

```{r compare_particle_number, eval=FALSE}
# Comparing runs with 10 and 100 particles released per day (total 2420 vs. 24 200) 
year <- 2018
timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
runs<-c("neutralParticles_10pertimestep","neutralParticles")

for(i in 1:2){
  run_name <- paste0(runs[i],"_",timespan)
  resultfile <- paste0("../results/",run_name,".nc")
  DriftFile <- nc_open(resultfile, write=FALSE) #for nc
  #print(DriftFile)
  #id  <- ncvar_get(DriftFile, 'trajectory')  # Particle ID
  #Create vector of timesteps in days:
  timesteps  <- ncvar_get(DriftFile, 'time')  # seconds since 1970-01-01 00:00:00 
  dates <- as.Date(as.POSIXct(timesteps, origin="1970-01-01"))
  
  days_timestep<-diff(timesteps)[1]/(60*60*24) #days per timestep
  timesteps_days<-rep(NA,length(timesteps));timesteps_days[1]<-days_timestep 
  for (j in 2:length(timesteps_days)){timesteps_days[j]<-timesteps_days[j-1]+days_timestep}
  timesteps_days_rounded<-ceiling(timesteps_days)

  dates_days <- data.frame(day=timesteps_days_rounded,date=dates)
    assign(paste0("dates_days", year), dates_days)
  
  #Extract relevant variables
  status <- ncvar_get(DriftFile, 'status')    #0=active,<0=stranded/not yet released
  release_month <- ncvar_get(DriftFile, 'origin_marker');release_month[status<0]<-NA
  lon <- ncvar_get(DriftFile, 'lon');lon[status<0]<-NA
  lat <- ncvar_get(DriftFile, 'lat');lat[status<0]<-NA
  depth <- ncvar_get(DriftFile, 'z');depth[status<0]<-NA
  age_seconds <- ncvar_get(DriftFile, 'age_seconds');age_seconds[status<0]<-NA
  age_days <- floor(age_seconds/(60*60*24))
  bottom_depth <- ncvar_get(DriftFile, 'sea_floor_depth_below_sea_level');bottom_depth[status<0]<-NA
  
  nc_close(DriftFile)
  
  # Make dataframe of relevant variables
  dayvector <- rep(timesteps_days_rounded, each = dim(release_month)[2])
  datevector <- rep(dates, each = dim(release_month)[2])
  
  dat <- pivot_longer(as.data.frame(release_month), cols= 1:dim(release_month)[2], values_to = "release_month", names_to = "ID")  %>%
        mutate(day=dayvector)  %>%
        mutate(date=datevector)  %>%
        mutate(age=c(t(age_days)))  %>%
        mutate(lon=c(t(lon)))  %>%
        mutate(lat=c(t(lat)))  %>%
        mutate(depth=c(t(depth)))   %>%
        filter(!is.na(release_month))
    
  assign(paste0(run_name,"_dat"), dat)
  
  rm(resultfile, DriftFile, timesteps, days_timestep, timesteps_days, timesteps_days_rounded, release_month, status, lon, lat, depth, age_seconds, age_days, datevector)
}


# Comparing cumulative particle distribution

plotlist <- list()

for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  
  # Counting the number of particles:
  rasterNumParts <- rasterize(x=dat_sp[,"ID"], y=fullRaster, fun="count")
  rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  rasterNumParts$Number <- rasterNumParts$ID
 
 maxval <- max(rasterNumParts$Number)

 if(x == 1){zlims <- c(0,300)} else {
    zlims <- c(0,3000)
  }
 
  fullmap <- ggmap(maparea_all) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red")) +
    coord_cartesian() +
    #scale_fill_gradientn(colours=topo.colors(500, alpha=0.4), name="Number") +
    geom_rect(aes(xmin = 17.7, xmax = 19.2, ymin =
        min(rasterNumParts$y), ymax = 69.7), color="black",fill=NA) + 
    ggtitle(paste0(year,": ", runs[x],"\nMax: ", round(maxval))) +
    theme(plot.margin = unit(rep(.5, 4), "lines"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

  zoommap <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red")) +
    xlab("Lon (Â°E)") + ylab("Lat (Â°N)") +
    theme(plot.margin = unit(rep(.5, 4), "lines"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

  # Comparing mean particle depth:
  plot_dep <- dat %>% 
   filter(age != 0) %>%
   group_by(date) %>% 
   summarise(depth = mean(depth)) %>%
    ggplot(aes(x=date,y=depth)) +
  geom_line()+
  ylim(c(-50, 0 )) +
  ylab("Mean particle depth") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) 
  

plotlist <- append(plotlist, list(fullmap, zoommap, plot_dep)) 
  
rm(dat)
}

grid.arrange(grobs = plotlist, layout_matrix = matrix(c(1:6),nrow=3,byrow=FALSE))


```


# References