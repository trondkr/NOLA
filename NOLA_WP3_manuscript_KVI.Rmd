---
output: 
 
   word_document:
    reference_docx: draft-styles-word.docx
    fig_caption: true # Make sure images are treated as figures
    number_sections: false # Number sections
    #toc: true # Gives Table of Contents 
    #toc_depth: 2
    pandoc_args:
    - '--lua-filter=scholarly-metadata.lua'
    - '--lua-filter=author-info-blocks.lua'
bibliography: library.bib
csl: frontiers-in-marine-science.csl
title: "Seasonal and interannual variation in river water influence in an Arctic fjord"
author:
  - Kristina Ø. Kvile:
      email: kristina.kvile@niva.no
      institute: [NIVA]
      correspondence: true
  - name: Trond Kristiansen
    institute: [NIVA]
  - name: Jon Albretsen
    institute: [IMR]
  - name: Angelika Renner
    institute: [IMR]
  - name: Amanda Poste 
    institute: [NIVA]
institute:
  - NIVA: Norwegian Institute for Water Research, Oslo, Norway
  - IMR: Institute of Marine Research, Bergen, Norway
abstract: "**Abstract**: *Introduction:* Climate change effects on freshwater fluxes in coastal ecosystems. *Method*: Particle tracking runs, following the fate of particles released at the Målselv river mouth into the Malangen fjord and eventually entering the Norwegian Sea. *Results*: Seasonal and interannual variation in residence time of river water, spatial extent of river water. Effect of different particle types (neutral vs. sinking, or other properties such as degradation time?). *Discussion*: Inputs from rivers to coast, potential ecological effects (light and nutrient availability, stratification)."
editor_options: 
  chunk_output_type: console
  always_allow_html: true
---


```{r settings, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
knitr::opts_chunk$set(fig.retina = 1)

setwd("C:/NOLA-SIS_lokal/NOLA")

# libraries
#library(ncdf)
library(ncdf4)
library(maps)
library(mapdata)
library(ggmap)
library(tidyverse)
library(sp)
library(raster)
library(captioner)
library(knitr)
library(grid)
library(gridExtra)

# Function to find first day of given month
firstDayMonth=function(x)
{           
  x=as.Date(as.character(x))
  day = format(x,format="%d")
  monthYr = format(x,format="%Y-%m")
  y = tapply(day,monthYr, min)
  first=as.Date(paste(row.names(y),y,sep="-"))
}


# Map layers
maparea_all <- get_stamenmap(bbox = c(left = 15.7, bottom = 69.2, right = 22.8,
                                       top = 71.4), 
                                 zoom = 8,maptype = 'terrain-background')
  
maparea_zoom <- get_stamenmap(bbox = c(left = 17.7, bottom = 69.28,                                          right = 19.2, top = 69.7), 
                                zoom = 10,maptype = 'terrain-background')


# Figure labels
figs <- captioner(prefix="Figure")


study_area <- figs(name="study_area","Study area. The black points show the particle release area at the mouth of the Målselv river. The colored boxes show the limits of four areas used to describe the distribution of river particles in time.")
particle_release <- figs(name="particle_release","Number of particles released per day (A) and the cumulative number of particles during the run (B), illustrated for one year (2018, the setup is the same for all years).")
num_particles <- figs(name="num_particles","Cumulative distribution of particles during the simulation for one year (counting all particles that have passed through a grid cell). The top panels show the full distribution of particles, and the lower panels a zoomed-in view of the Malangen system (indicated with a black rectangle in the upper panel). Runs with neutrally buoyant and sinking particles are compared (upper/lower), the color scales differ between the runs. Note that the top range of the scale have been limited to the same color allow visualization (the maximum number of particles counted in a grid cell is indicated in the title).")
num_particles_day <- figs(name="num_particles_day","Distribution of particles in the study area at the first day of every 2nd month during the simulation (counting all particles that are in a grid cell that day). Runs with neutrally buoyant and sinking particles are compared (left/right columns), the color scales differ between the runs. Note that the top range of the scale have been limited to the same color allow visualization (the maximum number of particles counted in a grid cell is indicated per panel).")
num_particles_box <- figs(name="num_particles_box","Number of particles present within each subregion of the study area per day during the simulation, color-coded by release month. Note, the different colors do not overlap but are stacked vertically. Also note that the y-axis differ for the neutrally buoyant and sinking particles.")
age_particles_day <- figs(name="age_particles_day","Age distribution of particles at the first day of every 2nd month during the simulation (calculating the mean age for all particles that are in a grid cell that day). Note that all values over 250 are diplayed in the same color (maximum outlier value was 302).")



```


```{r read_opendrift_output, include=FALSE}
year <- 2018
timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
runs<-c("neutralParticles","sinkingParticles_-0.001ms")

for(i in 1:2){
  run_name <- paste0(runs[i],"_",timespan)
  resultfile <- paste0("../results/",run_name,".nc")
  DriftFile <- nc_open(resultfile, write=FALSE) #for nc
  #print(DriftFile)
  #id  <- ncvar_get(DriftFile, 'trajectory')  # Particle ID
  #Create vector of timesteps in days:
  timesteps  <- ncvar_get(DriftFile, 'time')  # seconds since 1970-01-01 00:00:00 
  dates <- as.Date(as.POSIXct(timesteps, origin="1970-01-01"))
  
  days_timestep<-diff(timesteps)[1]/(60*60*24) #days per timestep
  timesteps_days<-rep(NA,length(timesteps));timesteps_days[1]<-days_timestep 
  for (j in 2:length(timesteps_days)){timesteps_days[j]<-timesteps_days[j-1]+days_timestep}
  timesteps_days_rounded<-ceiling(timesteps_days)

  dates_days <- data.frame(day=timesteps_days_rounded,date=dates)
  
  #Extract relevant variables
  status <- ncvar_get(DriftFile, 'status')    #0=active,<0=stranded/not yet released
  release_month <- ncvar_get(DriftFile, 'origin_marker');release_month[status<0]<-NA
  lon <- ncvar_get(DriftFile, 'lon');lon[status<0]<-NA
  lat <- ncvar_get(DriftFile, 'lat');lat[status<0]<-NA
  depth <- ncvar_get(DriftFile, 'z');depth[status<0]<-NA
  age_seconds <- ncvar_get(DriftFile, 'age_seconds');age_seconds[status<0]<-NA
  age_days <- floor(age_seconds/(60*60*24))
  
  nc_close(DriftFile)
  
  # Make dataframe of relevant variables
  dayvector <- rep(timesteps_days_rounded, each = dim(release_month)[2])
  datevector <- rep(dates, each = dim(release_month)[2])
  
  dat <- pivot_longer(as.data.frame(release_month), cols= 1:dim(release_month)[2], values_to = "release_month", names_to = "ID")  %>%
        mutate(day=dayvector)  %>%
        mutate(date=datevector)  %>%
        mutate(age=c(t(age_days)))  %>%
        mutate(lon=c(t(lon)))  %>%
        mutate(lat=c(t(lat)))  %>%
        mutate(depth=c(t(depth)))   %>%
        filter(!is.na(release_month))
    
  assign(paste0(run_name,"_dat"), dat)
  rm(resultfile, DriftFile, timesteps, days_timestep, timesteps_days, timesteps_days_rounded, release_month, status, lon, lat, depth, age_seconds, age_days, datevector)
}

num_particles_timestep <- dat %>% 
  group_by(date) %>% 
  summarize(total = n_distinct(ID))  %>% 
  mutate(new = total - lag(total))   %>% 
  mutate(new = replace_na(new, 10))
  

```

```{r read_river_file, include=FALSE}
RiverFile <- nc_open(paste0("../NorKyst_files/norfjords_160m_river.nc"), write=FALSE) #for nc
#print(RiverFile)
river_num <- ncvar_get(RiverFile, 'river')  # river number
timesteps_river <- ncvar_get(RiverFile, 'river_time')  # days since 1948-01-01 00:00:00 
dates_river <- as.Date(timesteps_river, origin="1948-01-01")

transport <- ncvar_get(RiverFile, 'river_transport') #river runoff vertically integrated mass transport, units: meter3 second-1

dates_sel <- which(dates_river >= min(dat$date) & dates_river <= max(dat$date))

river_sel <- 167 # Målselv

transport <- transport[river_sel, dates_sel]
transport <- data.frame(release_date=dates_river[dates_sel], transport=transport)
nc_close(RiverFile)

rm(river_num, timesteps_river, RiverFile, dates_sel, river_sel, dates_river)
```

```{r scale_by_river_volume, include=FALSE}


for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
 # Full join doesn't work with dates  
  dat_releaseday <- get(paste0(run_name,"_dat")) %>%
    group_by(ID) %>% 
    slice(1)  %>% 
    mutate(release_date = as.character(date)) %>% 
    dplyr::select(c(ID,release_date))

  dat <- get(paste0(run_name,"_dat")) %>%
    mutate(date = as.character(date)) %>%
    left_join(dat_releaseday) %>%
    left_join(transport %>% mutate(release_date = as.character(release_date))) %>%
    left_join(num_particles_timestep %>% mutate(release_date = as.character(date)) %>% dplyr::select(release_date, new)) %>%
    mutate(vol_particle = transport/new) %>%
    dplyr::select(!(new))  %>%
    mutate(date = as.Date(date))
  
  assign(paste0(run_name,"_dat"), dat)

  }


```

```{r define_boxes, include=FALSE}

local_box_lon = c(18.462861, 18.562647)
local_box_lat = c(69.304173, 69.357645)

inner_box_lon = c(18.349934, 19.000649)
inner_box_lat = c(69.257388, 69.438920)

middle_box_lon = c(17.863399, 18.718452)
middle_box_lat = c(69.438921, 69.571700)

outer_box_lon = c(17.508940, 18.035973)
outer_box_lat = c(69.571701, 69.653855)

#Set resolution 
reso <- c(0.01,0.005)

#Creating raster for full study area
i<-1 
dat <- get(paste0(runs[i],"_",timespan,"_dat"))

fullRaster <- raster(resolution = reso, xmn=min(dat$lon), xmx=max(dat$lon), ymn=min(dat$lat), ymx=max(dat$lat))

localRaster <- raster(resolution = reso, xmn=min(local_box_lon), xmx=max(local_box_lon), ymn=min(local_box_lat), ymx=max(local_box_lat))


```



# Introduction

* Broad climate change context for the global north and for Northern Norway 
    + Shifts in hydrology (freshwater fluxes, seasonality, frequency of high flow events) 
    + Coastal darkening
*	Importance of rivers for transport of nutrients/C/particles to the sea
*	Difference between dissolved (e.g. nutrients) and particulate (e.g. sediment particles) matter in behavior, residence time…
*	Potential impacts on coastal ecosystems (light availability, nutrient availability, stratification)
*	Importance of residence time for the effect of river water in fjord systems
*	If the residence time is very short, does the river output matter?
*	Importance of spatial extent – how far does the river output reach? 
*	Seasonal variation (spring freshet, degree of wind mixing), spatial variation (broad vs. narrow fjord system, deep vs. shallow sill) - if we compare different systems

## Aims
For a northern Norwegian case study site (Malangen, potentially compared with the Tana fjord), use high-resolution particle-tracking modeling to study the seasonality of river outflow and residence time of river water in the fjord to better understand the potential effect of of seasonality and high flow events for coastal darkening, river biogeochemistry and land-ocean fluxes.  
        

# Methods

## Study area
The study area encompasses the mouth of the Målselv river in Northern Norway and the downstream Malangen fjord that can transport river water out into the Norwegian Sea (`r figs("study_area", display = "cite")`). We released particles in a band at the river mouth of the Målselv river, i.e. at the transition from ~5 meter to deeper water. The study area was divided into four boxes at varying distance from the river mouth to study the flux of river water and residence time.  
*We could potentially compare to another system, f.ex. Tana?*

```{r study_area, fig.cap = study_area, fig.height = 4, fig.width = 7}
#Plot distribution at release
maparea_study <- get_stamenmap(bbox = c(left = 17.2, bottom = 69.2, 
                                        right = 19.35, top = 69.7), 
                               zoom = 8,maptype = 'terrain-background')

ggmap(maparea_study) + 
  geom_rect(aes(xmin = min(local_box_lon), xmax = max(local_box_lon), ymin = min(local_box_lat), ymax = max(local_box_lat)), alpha=0.2, fill="red") +
  geom_text(aes(x = min(local_box_lon), y = max(local_box_lat-0.02), label = "Local box"),size = 4, vjust = 0, hjust = 0)+
  geom_rect(aes(xmin = min(inner_box_lon), xmax = max(inner_box_lon), ymin = min(inner_box_lat), ymax = max(inner_box_lat)), alpha=0.1, fill="orange") +
    geom_text(aes(x = min(inner_box_lon), y = max(inner_box_lat-0.02), label = "Inner box"),size = 4, vjust = 0, hjust = 0)+
    geom_rect(aes(xmin = min(middle_box_lon), xmax = max(middle_box_lon), ymin = min(middle_box_lat), ymax = max(middle_box_lat)), alpha=0.1, fill="green") +
      geom_text(aes(x = min(middle_box_lon), y = max(middle_box_lat-0.02), label = "Middle box"),size = 4, vjust = 0, hjust = 0)+
    geom_rect(aes(xmin = min(outer_box_lon), xmax = max(outer_box_lon), ymin = min(outer_box_lat), ymax = max(outer_box_lat)), alpha=0.1, fill="blue") +
        geom_text(aes(x = min(outer_box_lon), y = max(outer_box_lat-0.02), label = "Outer box"),size = 4, vjust = 0, hjust = 0) +
   geom_point(data=dat  %>% filter(day==1),
             aes(x = lon, y = lat), size=0.1,color="black")  +
  geom_text(aes(x = max(local_box_lon), y = min(local_box_lat-0.04), label = "Release area"),size = 4, vjust = 0, hjust = 0) +
geom_curve(aes(x = max(local_box_lon)+2, y = min(local_box_lat-2), xend = min(local_box_lon), yend = min(local_box_lat)),
           arrow = arrow(length = unit(0.03, "npc"))) + 
  geom_segment(aes(x = max(local_box_lon), y = min(local_box_lat)-0.02, xend = mean(local_box_lon), yend = min(local_box_lat)-0.002),
           arrow = arrow(length = unit(0.15, "cm"))) + 
   xlab("Lon (°E)") + ylab("Lat (°N)")

```

## Simulation of river particle drift
We started the particle drift simulation on the 1st of February each year (2018, 2019, 2020) and followed the drift of particles until the end of the same year (31st of December, i.e. each year was simulated separately). We released 10 particles per day from the 1st of February until the end of September, resulting in a total of 2420 particles per year (`r figs("particle_release", display = "cite")`). The particles were released at the surface in a band from 18.538°E/69.308°N to 18.506°E/69.306°N (`r figs("study_area", display = "cite")`). We followed the drift of particles until the end of the year (31st of December).   

To get a more detailed view of the seasonal variation in water flow, we scaled the particles by the total river water volume flux at the release day (vertically integrated mass transport, in m^3-day^ , *source?*). I.e., the particles released at a specific day was weighted by the volume flux at that day, divided by the total number of particles released that day, so that the particles represent the volume flux. In that way, particles released during the spring and summer flood period gets more weight in the analyses (`r figs("particle_release", display = "cite")`).  

*As a first trial, this is done for 2018, but the same will be repeated for 2019.*   
*We can increase the number of particles simulated in the runs once we're happy with the setup.*  

```{r particle_release, fig.cap = particle_release, fig.height = 4, fig.width = 7}

newp <- 
  ggplot(data=num_particles_timestep, aes(x=date,y=new)) +
  geom_bar(stat="identity", fill = "light blue", width = 0.5)+
  ylab("New particles released per day") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("A")

allp <- 
  ggplot(data=num_particles_timestep, aes(x=date,y=total)) +
  geom_bar(stat="identity", fill ="light blue", width = 0.5)+
  ylab("Total number of active particles") +
  theme_minimal()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("B")


volp <- ggplot(data=transport, aes(x=release_date,y=transport)) +
  geom_bar(stat="identity", fill ="light blue", width = 0.5) +
  ylab("Total volume flux (m3/d)") +
  theme_minimal()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("C") + xlab("date")


grid.arrange(newp,allp,volp,ncol=3)  

```

To model particle drift with ocean currents, we used the open source trajectory modelling framework OpenDrift [@Dagestad2018] which was coupled offline to the Norkyst ocean model reanalysis with 160 m horizontal spatial resolution... *more info on Norkyst here*...  

We applied two different setups of the particle drift model, one setup where particles represent dissolved material and are neutrally buoyant particles (i.e. following the vertical movement of water) and one setup where particles represent particulate material (i.e. being influenced by the vertical movement of water but also sinking towards the seafloor with a certain fixed sinking speed). For the sinking particles, we **tested a sinking speed of 1 mm/s**.  

For both the neutrally buoyant and sinking particles, we used the following settings in the particle tracking simulations (*this list is more for discussion with the oceanographers, probably don't need all the detail in the manuscript...*):  

* Particles that hit land move back to their previous location in the ocean
* Particles that hit the ocean floor are still moved with the bottom currents (*we can change this so that they become deactivated.*)
* Vertical mixing was activated so that particles move vertically to eddy diffusivity and buoyancy 
* Vertical turbulent mixing was parameterized from wind speed (Sundby, 1983) - *this was included because the vertical diffusivity  included in the Norkyst files included some unrealistic values*
* Vertical advection was activated so that particles are moved vertically according to vertical ocean currents *has minimal impact compared to vertical turbulent mixing and can probably be ignored*
* Horizontal diffusivity was set to 10 m2/s



## Analyses

How the data were analyzed, visualized....  

* Monthly distribution and extent of river particles
* Residence time of river particles
* Interannual differences/difference between neutral and buoyant particles


# Results
Cumulatively over the course of the year (February to December), water particles originating from the Målselv river are distributed thorughout the study area and far east into the Norwegian Sea and north along the coastal system (`r figs("num_particles", display = "cite")`). The highest densities particles over time are found in some local areas along the coast in the inner Malangen fjord, in addition to the release area (where all river water passes through initially, `r figs("num_particles", display = "cite")`).  

*If we want to plot the full distribution as in the upper panel here, we should add another ocean model that covers the outside of the system to avoid the sharp edges.*  

```{r num_particles, fig.cap = num_particles, fig.height = 9, fig.width = 7}

plotlist <- list()

for(x in 1:2){
  if(x == 1){zlims <- c(0,500000)} else {
    zlims <- c(0,5000000)
  }
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  
  # Counting the number of particles:
  # rasterNumParts <- rasterize(x=dat_sp[,"ID"], y=fullRaster, fun="count")
  # rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
 
  # Summing the volume of particles:
  rasterNumParts <- rasterize(x=dat_sp[,"vol_particle"], y=fullRaster, fun="sum")
  rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  maxval <- max(rasterNumParts$ID)
    
  fullmap <- ggmap(maparea_all) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=ID), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    coord_cartesian() +
    #scale_fill_gradientn(colours=topo.colors(500, alpha=0.4), name="Number") +
    xlab("Lon (°E)") + ylab("Lat (°N)") +
    geom_rect(aes(xmin = 17.7, xmax = 19.2, ymin =
        min(rasterNumParts$y), ymax = 69.7), color="black",fill=NA) + 
    ggtitle(paste0(year,": ", runs[x],"\nMax: ", maxval)) +
    theme(plot.margin = unit(rep(.5, 4), "lines"))

  zoommap <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=ID), interpolate = TRUE) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    xlab("Lon (°E)") + ylab("Lat (°N)") +
    theme(plot.margin = unit(rep(.5, 4), "lines"))

plotlist <- append(plotlist, list(fullmap, zoommap)) 
  
}

grid.arrange(grobs = plotlist, layout_matrix = matrix(c(1,2,3,4),nrow=4,byrow=FALSE))


```
  
`r figs("num_particles_day", display = "cite")` shows the distribution of particles at the first day of each month of the simulation.  

```{r num_particles_day, fig.cap = num_particles_day, fig.height = 11, fig.width = 9}


plotlist <- list()

for(x in 1:2){
  if(x == 1){zlims <- c(0,1000)} else {
    zlims <- c(0,50000)
  }
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  days <- firstDayMonth(unique(dat_sp$date))[seq(2,10,by=2)]


  for(i in 1:length(days)){
    dat_i <- dat_sp[dat_sp$date==days[i],]
    # Counting the number of particles:
    # rasterNumParts <- rasterize(x=dat_i[,"ID"], y=fullRaster, fun="count")
    # rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    # maxval <- max(rasterNumParts$ID)
    
    # Summing the volume of particles:
    rasterNumParts <- rasterize(x=dat_i[,"vol_particle"], y=fullRaster, fun="sum")
    rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    maxval <- max(rasterNumParts$ID)

    dayplot <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=ID), interpolate = TRUE) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    ggtitle(paste0(days[i], "\nMax: ", maxval)) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          plot.margin = unit(c(-2,0,-0.5,0), "lines"),
          plot.title=element_text(margin=margin(t=40,b=-30)),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
    
    plotlist <- append(plotlist, list(dayplot)) 
  
  }
  
  lastplot <- ggmap(maparea_zoom) +
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=ID), interpolate = TRUE) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"), name="Number") +
    theme(legend.direction = "horizontal") 

  legend <- cowplot::get_legend(lastplot)
  plotlist <- append(plotlist, list(legend))
  
  #do.call("grid.arrange", c(plotlist, ncol=3,heights=unit(rep(5,3), "in")))
}

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:12),ncol=2,byrow=FALSE),
             top=textGrob("Neutral              Sinking"))

```


`r figs("num_particles_box", display = "cite")` shows the number of particles present within each per box (`r figs("study_area", display = "cite")`) per day during the simulation. The colors indicate the month of release of the particle ("origin").      

  
```{r num_particles_box, fig.cap = num_particles_box, fig.height = 8, fig.width = 9}

plotlist <- list()
xlims<-(c(min(dat$date),max(dat$date)))
  
 
for(x in 1:2){
 dat <- get(paste0(runs[x],"_",timespan,"_dat"))
 if(x==1){ ylims <- c(0,550)} else {
   ylims <- c(0,2000)
 }

 for(i in c("local","inner","middle","outer")){
  lon_i <- get(paste0(i,"_box_lon"))
  lat_i <- get(paste0(i,"_box_lat"))
  
  counts_i <- dat %>% 
    filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
    filter(lat>min(lat_i) & lat<max(lat_i)) %>% 
    group_by(day, origin) %>% 
    tally() %>% 
    left_join(dates_days)  %>% 
    rename(Month = origin, Date = date)
  
  plot_i <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                 xlab("") +
                 ylab("Number of particles") +
                 ggtitle(paste0(i," box"))  +
                 theme_minimal() + theme(legend.position = "null")
  
  if(i == "local" & x ==1){
  plot_legend <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                 xlab("") +
                 ylab("") +
                 ggtitle(paste0(i," box"))  +
                 theme_minimal() +
    theme(legend.direction = "horizontal") 

  plot_legend <- cowplot::get_legend(plot_legend)
  }
  
  
  plotlist <- append(plotlist, list(plot_i))
 }
}
 
plotlist <- plotlist[-8]
plotlist <- append(plotlist, list(plot_legend))
 
grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:8),ncol=2,byrow=FALSE),
             top=textGrob("Neutral              Sinking"), left=textGrob("Number of particles", rot=90))


```

`r figs("age_particles_day", display = "cite")` shows the mean age of particles at the first day of each month of the simulation.  

```{r age_particles_day, fig.cap = age_particles_day, fig.height = 11, fig.width = 9}

days <- firstDayMonth(unique(dat_sp$date))[seq(2,10,by=2)]

plotlist <- list()

for(x in 1:2){
  if(x == 1){zlims <- c(0,250)} else {
    zlims <- c(0,250)
  }
 dat <- get(paste0(runs[x],"_",timespan,"_dat"))
 dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)

  for(i in 1:length(days)){
    dat_i <- dat_sp[dat_sp$date==days[i],]
    rasterNumParts <- rasterize(x=dat_i[,"age"], y=fullRaster, fun=mean)
    rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    maxval <- max(rasterNumParts$age)

    dayplot <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=age)) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    ggtitle(paste0(days[i], "\nMax: ", maxval)) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          plot.margin = unit(c(-2,0,-0.5,0), "lines"),
          plot.title=element_text(margin=margin(t=40,b=-30)),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
    
    plotlist <- append(plotlist, list(dayplot)) 
  
  }
   lastplot <- ggmap(maparea_zoom) +
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=age)) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"), name="Age (days)") +
    theme(legend.direction = "horizontal") 

  legend <- cowplot::get_legend(lastplot)
  plotlist <- append(plotlist, list(legend))
}

  


grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:12),ncol=2,byrow=FALSE),
             top=textGrob("Neutral              Sinking"))

```


# Discussion

# Acknowledgements

# References