---
output: 
 
   word_document:
    reference_docx: draft-styles-word.docx
    fig_caption: true # Make sure images are treated as figures
    number_sections: false # Number sections
    #toc: true # Gives Table of Contents 
    #toc_depth: 2
    pandoc_args:
    - '--lua-filter=scholarly-metadata.lua'
    - '--lua-filter=author-info-blocks.lua'
bibliography: library.bib
csl: frontiers-in-marine-science.csl
title: "Seasonal and interannual variation in river water influence in an Arctic fjord"
author:
  - Kristina Ø. Kvile:
      email: kristina.kvile@niva.no
      institute: [NIVA]
      correspondence: true
  - name: Michael Bedington
    institute: [apn]
  - name: Trond Kristiansen
    institute: [NIVA]
  - name: Jon Albretsen
    institute: [IMR]
  - name: Angelika Renner
    institute: [IMR]
  - name: Amanda Poste 
    institute: [NIVA]
institute:
  - NIVA: Norwegian Institute for Water Research, Oslo, Norway
  - apn: Akvaplan-Niva AS, Oslo, Norway
  - IMR: Institute of Marine Research, Bergen, Norway
abstract: "**Abstract**: *Introduction:* Climate change effects on freshwater fluxes in coastal ecosystems. *Method*: Particle tracking runs to simulate material origating from the river (dissoved or particulate), following the fate of material released at the Målselv river mouth into the Malangen fjord and eventually entering the Norwegian Sea. *Results*: Seasonal and interannual variation in residence time of river material, spatial extent of river material. Differences between dissolved (neutral) and particulate (sinking) material. *Discussion*: Inputs from rivers to coast, potential ecological effects (light and nutrient availability, stratification)."
editor_options: 
  chunk_output_type: console
  always_allow_html: true
---


```{r settings, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
knitr::opts_chunk$set(fig.retina = 1)

setwd("C:/NOLA-SIS_lokal/NOLA")

# libraries
#library(ncdf)
library(ncdf4)
library(maps)
library(mapdata)
library(ggmap)
library(tidyverse)
library(sp)
library(raster)
library(captioner)
library(knitr)
library(grid)
library(gridExtra)
library(zoo)

# Function to find first day of given month
firstDayMonth=function(x)
{           
  x=as.Date(as.character(x))
  day = format(x,format="%d")
  monthYr = format(x,format="%Y-%m")
  y = tapply(day,monthYr, min)
  first=as.Date(paste(row.names(y),y,sep="-"))
}


# Map layers
maparea_all <- get_stamenmap(bbox = c(left = 16.1, bottom = 69.2, right = 21.8,
                                      top = 70.35), 
                             zoom = 8,maptype = "toner-lite")

maparea_zoom <- get_stamenmap(bbox = c(left = 17.7, bottom = 69.28,                                          right = 19.2, top = 69.7), 
                                zoom = 10,maptype = 'toner-lite')


# Figure labels
figs <- captioner(prefix="Figure")


study_area <- figs(name="study_area","Study area. The black points show the particle release area at the mouth of the Målselv river. The colored boxes show the limits of four areas used to quantify the distribution of river material.")

particle_release <- figs(name="particle_release","Number of particles released per day (A), the cumulative number of particles during the run (B), and the river volume flux per date for 2018 (C) and 2019 (D). Panels A and B are illustrated for one year, but the setup is the same for both years.")

num_particles <- figs(name="num_particles","Cumulative distribution of river material during the simulation for one year (counting all particles that have passed through a grid cell, with particles weighted by river water volume flux at the day of release). The top panels show the full distribution and the lower panels a zoomed-in view of the Malangen system (indicated with a black rectangle in the upper panel). Runs for two years with neutrally buoyant or sinking particles are compared. Note that the color scale has been truncated to maximum 15 000 for all panels to facilitate visualization and comparison (the maximum value for a single grid cell is indicated in the title).")

num_particles_day <- figs(name="num_particles_day","Distribution of river water material in the study area at the first day of every 2nd month during the simulation (counting all particles that are in a grid cell that day, weighting particles by river water volume flux at the day of release). Runs with neutrally buoyant and sinking particles are compared, the color scales differ between the runs. Note that the color scale has been truncated to a fixed number to allow visualization (the maximum value for a single for a single grid cell is indicated per panel).")

num_particles_box <- figs(name="num_particles_box","Number of particles present within each subregion of the study area per day during the simulation, color-coded by release month. Note, the different colors do not overlap but are stacked vertically. Also note that the y-axis differ for the neutrally buoyant and sinking particles.")

residence_time_box <- figs(name="residence_time_box","Residence time of particles in each box (in number of days) as a function of total volume flux at the time of particle release (5-days moving averarge counting from the day of release). The grey points are number of days for individual particles, thre green line shows the average residence time per value of total volume flux, and the black line show the relationship between residence time and total volume flux as a smooth function from a GAM with maximum 4 knots. Note that the y-axis differ between panels.")

age_particles_day <- figs(name="age_particles_day","Age distribution of particles at the first day of every 2nd month during the simulation (calculating the mean age for all particles that are in a grid cell that day). Note that all values over 250 are diplayed in the same color (maximum outlier value was 302).")



```


```{r read_opendrift_output, include=FALSE}
years <- c(2018,2019)
runs<-c("neutralParticles","sinkingParticles_-0.0003ms")

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  
for(i in 1:2){
  run_name <- paste0(runs[i],"_",timespan)
  resultfile <- paste0("../results/",run_name,".nc")
  DriftFile <- nc_open(resultfile, write=FALSE) #for nc
  #print(DriftFile)
  #id  <- ncvar_get(DriftFile, 'trajectory')  # Particle ID
  #Create vector of timesteps in days:
  timesteps  <- ncvar_get(DriftFile, 'time')  # seconds since 1970-01-01 00:00:00 
  dates <- as.Date(as.POSIXct(timesteps, origin="1970-01-01"))
  
  days_timestep<-diff(timesteps)[1]/(60*60*24) #days per timestep
  timesteps_days<-rep(NA,length(timesteps));timesteps_days[1]<-days_timestep 
  for (j in 2:length(timesteps_days)){timesteps_days[j]<-timesteps_days[j-1]+days_timestep}
  timesteps_days_rounded<-ceiling(timesteps_days)

  dates_days <- data.frame(day=timesteps_days_rounded,date=dates)
    assign(paste0("dates_days", year), dates_days)
  
  #Extract relevant variables
  status <- ncvar_get(DriftFile, 'status')    #0=active,<0=stranded/not yet released
  release_month <- ncvar_get(DriftFile, 'origin_marker');release_month[status<0]<-NA
  lon <- ncvar_get(DriftFile, 'lon');lon[status<0]<-NA
  lat <- ncvar_get(DriftFile, 'lat');lat[status<0]<-NA
  depth <- ncvar_get(DriftFile, 'z');depth[status<0]<-NA
  age_seconds <- ncvar_get(DriftFile, 'age_seconds');age_seconds[status<0]<-NA
  age_days <- floor(age_seconds/(60*60*24))
  bottom_depth <- ncvar_get(DriftFile, 'sea_floor_depth_below_sea_level');bottom_depth[status<0]<-NA
  
  nc_close(DriftFile)
  
  # Make dataframe of relevant variables
  dayvector <- rep(timesteps_days_rounded, each = dim(release_month)[2])
  datevector <- rep(dates, each = dim(release_month)[2])
  
  dat <- pivot_longer(as.data.frame(release_month), cols= 1:dim(release_month)[2], values_to = "release_month", names_to = "ID")  %>%
        mutate(day=dayvector)  %>%
        mutate(date=datevector)  %>%
        mutate(age=c(t(age_days)))  %>%
        mutate(lon=c(t(lon)))  %>%
        mutate(lat=c(t(lat)))  %>%
        mutate(depth=c(t(depth)))   %>%
        filter(!is.na(release_month))
    
  assign(paste0(run_name,"_dat"), dat)
  rm(resultfile, DriftFile, timesteps, days_timestep, timesteps_days, timesteps_days_rounded, release_month, status, lon, lat, depth, age_seconds, age_days, datevector)
}
  # The number of particles per timestep is the same for all runs
  num_particles_timestep <- dat %>% 
  group_by(date) %>% 
  summarize(total = n_distinct(ID))  %>% 
  mutate(new = total - lag(total))   %>% 
  mutate(new = replace_na(new, 10))
  
  assign(paste0("num_particles_timestep_", year), num_particles_timestep)
  rm(num_particles_timestep)
}


```

```{r read_river_file, include=FALSE}
RiverFile <- nc_open(paste0("../NorKyst_files/norfjords_160m_river.nc"), write=FALSE) #for nc
#print(RiverFile)
river_num <- ncvar_get(RiverFile, 'river')  # river number
timesteps_river <- ncvar_get(RiverFile, 'river_time')  # days since 1948-01-01 00:00:00 
dates_river <- as.Date(timesteps_river, origin="1948-01-01")

transport <- ncvar_get(RiverFile, 'river_transport') #river runoff vertically integrated mass transport, units: meter3 second-1 (day??)

timespan_min <- paste0(min(years), "-02-01")
timespan_max <- paste0(max(years), "-12-31-1")

dates_sel <- which(dates_river >= timespan_min & dates_river <= timespan_max)

river_sel <- 167 # Målselv

transport <- transport[river_sel, dates_sel]
#transport <- transport/1000 #(convert to m3^-1000)

transport <- data.frame(release_date=dates_river[dates_sel], transport=transport)
nc_close(RiverFile)

rm(river_num, timesteps_river, RiverFile, dates_sel, river_sel, dates_river)
```

```{r scale_by_river_volume, include=FALSE}

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  num_particles_timestep <- get(paste0("num_particles_timestep_",year))
                                
  for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  
 # Full join doesn't work with dates  
  dat_releaseday <- get(paste0(run_name,"_dat")) %>%
    group_by(ID) %>% 
    slice(1)  %>% 
    mutate(release_date = as.character(date)) %>% 
    dplyr::select(c(ID,release_date))

  dat <- get(paste0(run_name,"_dat")) %>%
    mutate(date = as.character(date)) %>%
    left_join(dat_releaseday) %>%
    left_join(transport %>% mutate(release_date = as.character(release_date))) %>%
    left_join(num_particles_timestep %>% mutate(release_date = as.character(date)) %>% dplyr::select(release_date, new)) %>%
    mutate(vol_particle = transport/new) %>%
    dplyr::select(!(new))  %>%
    mutate(date = as.Date(date))
  
  assign(paste0(run_name,"_dat"), dat)

  }
}

rm(dat_releaseday)
```

```{r define_boxes, include=FALSE}

local_box_lon = c(18.462861, 18.562647)
local_box_lat = c(69.304173, 69.357645)

inner_box_lon = c(18.349934, 19.000649)
inner_box_lat = c(69.257388, 69.438920)

middle_box_lon = c(17.823399, 18.718452)
middle_box_lat = c(69.438921, 69.571700)

outer_box_lon = c(17.308940, 18.135973)
outer_box_lat = c(69.571701, 69.71448)

#Set resolution 
reso <- c(0.01,0.005)

#Creating raster for full study area (note, reducing full area to remove particles that meet the borders of NorKyst)
i<-1 
dat <- get(paste0(runs[i],"_",timespan,"_dat"))

fullRaster <- raster(resolution = reso, xmn=16.1, xmx=21.8, ymn=69.2, ymx=70.35)

localRaster <- raster(resolution = reso, xmn=min(local_box_lon), xmx=max(local_box_lon), ymn=min(local_box_lat), ymx=max(local_box_lat))


```



# Introduction

* Broad climate change context for the global north and for Northern Norway 
    + Shifts in hydrology (freshwater fluxes, seasonality, frequency of high flow events) 
    + Coastal darkening
*	Importance of rivers for transport of nutrients/C/particles to the sea
*	Difference between dissolved (e.g. nutrients) and particulate (e.g. sediment particles) matter in behavior, residence time…
*	Potential impacts on coastal ecosystems (light availability, nutrient availability, stratification)
*	Importance of residence time for the effect of river water in fjord systems
*	If the residence time is very short, does the river output matter?
*	Importance of spatial extent – how far does the river output reach? 
*	Seasonal variation (spring freshet, degree of wind mixing), spatial variation (broad vs. narrow fjord system, deep vs. shallow sill) - if we compare different systems

## Aims
For a northern Norwegian case study site (Malangen, potentially compared with the Tana fjord), use high-resolution particle-tracking modeling to study the seasonality of river outflow and residence time of river water in the fjord to better understand the potential effect of of seasonality and high flow events for fjord biogeochemistry.  
        

# Methods

## Study area
The study area encompasses the mouth of the Målselv river in Northern Norway and the downstream Malangen fjord that can transport river water out into the Norwegian Sea (`r figs("study_area", display = "cite")`). The study area was divided into four boxes at varying distance from the river mouth to study the flux of river water and residence time.  

```{r study_area, fig.cap = study_area, fig.height = 4, fig.width = 7}
#Plot distribution at release
maparea_study <- get_stamenmap(bbox = c(left = 17.2, bottom = 69.2, 
                                        right = 19.35, top = 69.8), 
                               zoom = 8,maptype = 'toner-lite')

ggmap(maparea_study) + 
  geom_rect(aes(xmin = min(local_box_lon), xmax = max(local_box_lon), ymin = min(local_box_lat), ymax = max(local_box_lat)), alpha=0.2, fill="red") +
  geom_text(aes(x = min(local_box_lon), y = max(local_box_lat-0.02), label = "Local box"),size = 4, vjust = 0, hjust = 0)+
  geom_rect(aes(xmin = min(inner_box_lon), xmax = max(inner_box_lon), ymin = min(inner_box_lat), ymax = max(inner_box_lat)), alpha=0.1, fill="orange") +
    geom_text(aes(x = min(inner_box_lon), y = max(inner_box_lat-0.02), label = "Inner box"),size = 4, vjust = 0, hjust = 0)+
    geom_rect(aes(xmin = min(middle_box_lon), xmax = max(middle_box_lon), ymin = min(middle_box_lat), ymax = max(middle_box_lat)), alpha=0.1, fill="green") +
      geom_text(aes(x = min(middle_box_lon), y = max(middle_box_lat-0.02), label = "Middle box"),size = 4, vjust = 0, hjust = 0)+
    geom_rect(aes(xmin = min(outer_box_lon), xmax = max(outer_box_lon), ymin = min(outer_box_lat), ymax = max(outer_box_lat)), alpha=0.1, fill="blue") +
        geom_text(aes(x = min(outer_box_lon), y = max(outer_box_lat-0.02), label = "Outer box"),size = 4, vjust = 0, hjust = 0) +
   geom_point(data=dat  %>% filter(day==1),
             aes(x = lon, y = lat), size=0.1,color="black")  +
  geom_text(aes(x = max(local_box_lon), y = min(local_box_lat-0.04), label = "Release area"),size = 4, vjust = 0, hjust = 0) +
geom_curve(aes(x = max(local_box_lon)+2, y = min(local_box_lat-2), xend = min(local_box_lon), yend = min(local_box_lat)),
           arrow = arrow(length = unit(0.03, "npc"))) + 
  geom_segment(aes(x = max(local_box_lon), y = min(local_box_lat)-0.02, xend = mean(local_box_lon), yend = min(local_box_lat)-0.002),
           arrow = arrow(length = unit(0.15, "cm"))) + 
   xlab("Lon (°E)") + ylab("Lat (°N)")

```

## Simulating drift of material from river to ocean
We released particles in a band from 18.538°E/69.308°N to 18.506°E/69.306°N following river mouth of the Målselv river (`r figs("study_area", display = "cite")`). The particles were distributed randomly at depths between 0 and 5 m. We started the particle drift simulation on the 1st of February for each of two years (2018, 2019) and followed the drift of particles until the end of the same year (31st of December, i.e. each year was simulated separately). We released 100 particles per day from the 1^st^ of February until the end of September, i.e., a total of 24 200 particles per year (`r figs("particle_release", display = "cite")`).   

To get a more realistic representation of the seasonal variation in outflow of river material, we scaled the particles by the total river water volume flux at the release day (vertically integrated mass transport, in m^3-day^ *Jon: correct unit*?, *source?*). I.e., the particles released at a specific day were weighted by the volume flux at that day, divided by the total number of particles released that day. In that way, particles released during the spring and summer flood period gets more weight in the analyses and the "amount" represented by the particles reflect the volume flux (`r figs("particle_release", display = "cite")`).  

```{r particle_release, fig.cap = particle_release, fig.height = 6, fig.width = 7}

newp <- 
  ggplot(data=num_particles_timestep_2018, aes(x=date,y=new)) +
  geom_bar(stat="identity", fill = "light blue", width = 0.5)+
  ylab("Particles released daily") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("A")

allp <- 
  ggplot(data=num_particles_timestep_2018, aes(x=date,y=total)) +
  geom_bar(stat="identity", fill ="light blue", width = 0.5)+
  ylab("Number of active particles") +
  theme_minimal()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("B")


volp2018 <- ggplot(data=transport  %>%
                     filter(release_date<"2019-01-01"),
                   aes(x=release_date,y=transport)) +
  geom_bar(stat="identity", fill ="light blue", width = 0.5) +
  ylab("Total vol. flux (m3/d)") +
  theme_minimal()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("C") + xlab("date")

volp2019 <- ggplot(data=transport  %>%
                     filter(release_date>="2019-01-01"), aes(x=release_date,y=transport)) +
  geom_bar(stat="identity", fill ="light blue", width = 0.5) +
  ylab("Total vol. flux (m3/d)") +
  theme_minimal()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle("D") + xlab("date")

grid.arrange(newp, allp, volp2018, volp2019, ncol=2)  

```

To model particle drift with ocean currents, we used the open source trajectory modelling framework OpenDrift [@Dagestad2018] which was coupled offline to the NorFjords160 ocean model reanalysis with 160 m horizontal spatial resolution... *Jon: more info on NorFjords160 here*...  

We applied two different setups of the particle drift model, one setup where particles represent dissolved material and are neutrally buoyant (i.e. following the vertical movement of water) and one setup where particles represent particulate material and are negatively buoyant (i.e. being influenced by the vertical movement of water but also sinking towards the seafloor with a certain speed). For sinking particles, we tested sinking speeds of 0.3, 0.5 and 0.8 mm/s, representing mud and sand particles with grain size 0.05-0.2 mm (*references Mike?*). The resuspension threshold for sinking particles was set to 0.15 m/s (*references or more info Mike?*).   

```{r particle_depth, fig.cap = particle_depth, fig.height = 4, fig.width = 7, eval = FALSE}

year <- 2018
timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")

plotlist <- list()
for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  
  plot_dep <- get(paste0(run_name,"_dat")) %>% 
   filter(age != 0) %>%
   group_by(date) %>% 
   summarise(depth = mean(depth)) %>%
    ggplot(aes(x=date,y=depth)) +
  geom_line()+
  ylim(c(-80, 0 )) +
  ylab("Mean particle depth") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle(paste0(year,": ", runs[x]))
  
  plotlist <- append(plotlist, list(plot_dep)) 

}
grid.arrange(grobs = plotlist, ncol = 2)  

```

For both the neutrally buoyant and sinking particles, we used the following settings in the particle tracking simulations (*this list is more for our own reference , we probably don't need all the detail in the manuscript...*):  

* Particles that hit land move back to their previous location in the ocean
* Vertical mixing was activated so that particles move vertically according to eddy diffusivity and buoyancy 
* Vertical turbulent mixing was parameterized from wind speed (Sundby, 1983) - *this was included because the vertical diffusivity  included in the Norkyst files included some unrealistic values*
* Vertical advection was activated so that particles are moved vertically according to vertical ocean currents *has minimal impact compared to vertical turbulent mixing and could probably be ignored. Kept for now*
* Horizontal diffusivity was set to 10 m2/s




## Analyses

Description of how the data were analyzed, visualized....  

* Cumulative and monthly distribution of river material
* Residence time of river material in the different boxes
* Interannual differences/difference between neutral and buoyant particles


# Results
Cumulatively over the course of the year (February to December), material originating from the Målselv river is distributed thorughout the Malangen fjord system, into the Norwegian Sea and north along the Norwegian coast (`r figs("num_particles", display = "cite")`). The highest concentration of material or volume of water originating from the river is found in some local areas along the coast in the inner Malangen fjord, in addition to the release area (where all river water passes through initially, `r figs("num_particles", display = "cite")`). Comparing neutrally buyoant and sinking particles...

*If we want to plot the full distribution as in the upper panel here, we should add another ocean model that covers the outside of the system to avoid the sharp edges.*  

```{r num_particles, fig.cap = num_particles, fig.height = 7, fig.width = 7}

cols_order <- c("thistle","purple","blue","green","yellow","orange","red","dark red","black")
plotlist <- list()

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")

for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  
  # Counting the number of particles:
  # rasterNumParts <- rasterize(x=dat_sp[,"ID"], y=fullRaster, fun="count")
  # rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  #rasterNumParts$Number <- rasterNumParts$ID
 
  # Summing the volume of particles:
  rasterNumParts <- rasterize(x=dat_sp[,"vol_particle"], y=fullRaster, fun="sum")
  rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  rasterNumParts$Number <- rasterNumParts$vol_particle
  
 maxval <- max(rasterNumParts$Number)
 zlims <- c(0,15000)
 #zlims <- c(0, quantile(rasterNumParts$Number, 0.9999))

 
  fullmap <- ggmap(maparea_all) + 
  geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
  scale_fill_gradientn(limits = zlims,
                       na.value = "red", #na.value color same as color for max value
                       colours = cols_order) +
  coord_cartesian() +
  #scale_fill_gradientn(colours=topo.colors(500, alpha=0.4), name="Number") +
  geom_rect(aes(xmin = 17.7, xmax = 19.2, ymin =
                  min(rasterNumParts$y), ymax = 69.7), color="black",fill=NA) + 
  ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x])),
                 "\nMax: ", round(maxval))) +
  theme(legend.position = c(0.85, 0.25), legend.title = element_blank(),
        legend.key.width=unit(3,"mm"),legend.background=element_blank(),
        plot.margin = unit(rep(.5, 4), "lines"),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())


  zoommap <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = cols_order) +
    xlab("Lon (°E)") + ylab("Lat (°N)") +
    theme(legend.position = "none", 
          plot.margin = unit(rep(.5, 4), "lines"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.border = element_rect(colour = "black", fill=NA))

plotlist <- append(plotlist, list(fullmap, zoommap)) 
  
rm(dat)
}
}

grid.arrange(grobs = plotlist, layout_matrix = matrix(c(1:8),nrow=2,byrow=FALSE))

```
  

```{r num_particles_day, fig.cap = num_particles_day, fig.height = 12, fig.width = 9, eval=FALSE}

# `r figs("num_particles_day", display = "cite")` shows the distribution of water at the first day of each month of the simulation. *This figure could be moved to the supplementary material and potentially replaced by an animation.*  

plotlist <- list()

for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")

for(x in 1:2){
  if(x == 1){zlims <- c(0,3000)} else {
    zlims <- c(0,10000)
  }
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  days <- firstDayMonth(unique(dat_sp$date))[seq(2,10,by=2)]

  for(i in 1:length(days)){
    dat_i <- dat_sp[dat_sp$date==days[i],]
    # Counting the number of particles:
    # rasterNumParts <- rasterize(x=dat_i[,"ID"], y=fullRaster, fun="count")
    # rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    # maxval <- max(rasterNumParts$ID)
    
    # Summing the volume of particles:
    rasterNumParts <- rasterize(x=dat_i[,"vol_particle"], y=fullRaster, fun="sum")
    rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    maxval <- max(rasterNumParts$ID)

    dayplot <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=ID), interpolate = TRUE) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    ggtitle(paste0(days[i], "\nMax: ", maxval)) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          plot.margin = unit(c(-2,0,-0.5,0), "lines"),
          plot.title=element_text(margin=margin(t=40,b=-30)),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
    
    plotlist <- append(plotlist, list(dayplot)) 
  
  }
  
  lastplot <- ggmap(maparea_zoom) +
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=ID), interpolate = TRUE) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"), name="Number") #+
 #   theme(legend.direction = "horizontal") 

  legend <- cowplot::get_legend(lastplot)
  plotlist <- append(plotlist, list(legend))
  
  #do.call("grid.arrange", c(plotlist, ncol=3,heights=unit(rep(5,3), "in")))
}
}

grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:12),nrow=2,byrow=TRUE))

# grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:24),ncol=4,byrow=FALSE),
#              top=textGrob("Neutral   Sinking   Neutral  Sinking"))

```


`r figs("num_particles_box", display = "cite")` shows the number of particles present within each per box (`r figs("study_area", display = "cite")`) per day during the simulation. The colors indicate the month of release of the particle ("origin").      

```{r num_particles_box, fig.cap = num_particles_box, fig.height = 8, fig.width = 9}

plotlist <- list()
ylims <- c(0,28000)

for(year in years){
timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:2){
  dat <- get(paste0(runs[x],"_",timespan,"_dat"))
  xlims<-(c(min(dat$date),max(dat$date-1)))
  dates_days <- get(paste0("dates_days",year))
 
 #  if(x==1){ ylims <- c(0,160000)} else {
 #   ylims <- c(0,16000)
 # }

 for(i in c("local","inner","middle","outer")){
  lon_i <- get(paste0(i,"_box_lon"))
  lat_i <- get(paste0(i,"_box_lat"))
  
  counts_i <- dat %>% 
    filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
    filter(lat>min(lat_i) & lat<max(lat_i)) %>% 
    group_by(day, release_month) %>% 
    #tally() %>% # Counting number of particles
    summarize(n = sum(vol_particle)) %>% # Counting number of particles weighted by volume
    left_join(dates_days)  %>% 
    rename(Month = release_month, Date = date) %>% 
    mutate(Month = factor(Month, 
                             levels = as.character(seq(2,9))))
  
  plot_i <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month,color=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                ylab("") + 
                theme_minimal() + theme(legend.position = "null",
                axis.text.x=element_blank(),
        axis.title.x=element_blank())
  
  # Add year to upper row
  if(i == "local"){
    plot_i <- plot_i + 
      ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x]))))  
  }
  
  # Add xlab to lower row
  if(i == "outer"){
    plot_i <- plot_i + 
      theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
  }
  
  # Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i + 
      ylab(str_to_sentence(paste0(i," box")))
    }
   
  plotlist <- append(plotlist, list(plot_i))
    }
  }
}
 
# Add legend to last plot
plot_legend <- ggplot(data=counts_i, aes(x=Date,y=n,fill=Month,color=Month)) +
                 geom_bar(stat="identity") +
                 xlim(xlims) + ylim(ylims)+
                ylab("") + 
                theme_minimal() + theme(legend.position = "null",
                axis.text.x=element_text(angle=90,hjust=1,vjust=0.5),
        axis.title.x=element_blank())
  
                
plotlist[[length(plotlist)]] <- plot_legend
 
grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:16),ncol=4,byrow=FALSE),
            left=textGrob("Number of particles scaled by water volume", rot=90))

# grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:16),ncol=4,byrow=FALSE),
#              top=textGrob("Neutral              Sinking"), left=textGrob("Number of particles", rot=90))


```

`r figs("residence_time_box", display = "cite")` shows the mean residence time of particles in each box as a function of volume transport at the release time of the particle (5-days moving average counting from the day of release). It also includes particles that exit a box and then re-enters at a later point in time.    

```{r residence_time_box, fig.cap = residence_time_box, fig.height = 8, fig.width = 9}

# Calculate moving window of water volume transport (from release day and 4 following days)

transport <- transport %>% 
       mutate(transport_movavg = rollapply(transport, width = 5, FUN= mean, align = 'left', fill = NA))

xlims <- range(transport$transport_movavg)
ylims <- c(0,300)
plotlist <- list()
  
for(year in years){
  timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
  for(x in 1:2){
    dat <- get(paste0(runs[x],"_",timespan,"_dat"))
   #  xlims<-(c(min(dat$date),max(dat$date)))
   #  dates_days <- get(paste0("dates_days",year))
   # 
   #  if(x==1){ ylims <- c(0,700)} else {
   #   #ylims <- c(0,2000)
   #   ylims <- c(0,700)
   # }
  
   for(i in c("local","inner","middle","outer")){
    lon_i <- get(paste0(i,"_box_lon"))
    lat_i <- get(paste0(i,"_box_lat"))
    
    counts_i <- dat %>% 
      filter(lon>min(lon_i) & lon<max(lon_i)) %>% 
      filter(lat>min(lat_i) & lat<max(lat_i)) %>% 
      left_join(transport %>% mutate(release_date = as.character(release_date))) %>%
      group_by(ID, transport_movavg, release_date, release_month) %>% 
      tally() 
    
    plot_i <- ggplot(data=counts_i, aes(x=transport_movavg, y=n)) +
  geom_point(size=0.05, color = "dark grey") +
  stat_summary(fun = mean, geom="line", colour="dark green") +
  geom_smooth(method="gam", formula = y ~ s(x, bs = "cs", k = 4),
              color = "black", se = FALSE) +
  xlim(xlims) + 
  ylim(ylims) + 
  ylab("") +
  theme_minimal() + theme(legend.position = "null",
                          axis.text.x=element_blank(),
                          axis.title.x=element_blank())

    
  
      # Add year/run to upper row
  if(i == "local"){
    plot_i <- plot_i +
      ggtitle(paste0(year,": ", str_to_sentence(gsub("\\P.*","",runs[x]))))
  }

  # Add xlab to lower row
  if(i == "outer"){
    plot_i <- plot_i +
      theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
  }

  # Add indication of box to left column
  if(year == years[1] & x == 1){
    plot_i <- plot_i +
      ylab(str_to_sentence(paste0(i," box")))
  }

    plotlist <- append(plotlist, list(plot_i))
    } # Box
  } # Run
} # Year
 
grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:16),ncol=4,byrow=FALSE),
            left=textGrob("Residence time (days)", rot=90), bottom=textGrob("Total volume flux (m3/d)"))


```

```{r age_particles_day, fig.cap = age_particles_day, fig.height = 11, fig.width = 9,eval=FALSE}

days <- firstDayMonth(unique(dat_sp$date))[seq(2,10,by=2)]

plotlist <- list()

for(x in 1:2){
  if(x == 1){zlims <- c(0,250)} else {
    zlims <- c(0,250)
  }
 dat <- get(paste0(runs[x],"_",timespan,"_dat"))
 dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)

  for(i in 1:length(days)){
    dat_i <- dat_sp[dat_sp$date==days[i],]
    rasterNumParts <- rasterize(x=dat_i[,"age"], y=fullRaster, fun=mean)
    rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
    maxval <- max(rasterNumParts$age)

    dayplot <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=age)) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"),
                         name="Number") +
    ggtitle(paste0(days[i], "\nMax: ", maxval)) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          axis.title.y=element_blank(),
          legend.position="none",
          plot.margin = unit(c(-2,0,-0.5,0), "lines"),
          plot.title=element_text(margin=margin(t=40,b=-30)),
          panel.border = element_rect(colour = "black", fill=NA, size=1))
    
    plotlist <- append(plotlist, list(dayplot)) 
  
  }
   lastplot <- ggmap(maparea_zoom) +
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=age)) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red"), name="Age (days)") +
    theme(legend.direction = "horizontal") 

  legend <- cowplot::get_legend(lastplot)
  plotlist <- append(plotlist, list(legend))
}


grid.arrange(grobs=plotlist, layout_matrix = matrix(c(1:12),ncol=2,byrow=FALSE),
             top=textGrob("Neutral              Sinking"))

```


# Discussion

# Acknowledgements

# Supplemental figures
```{r compare_particle_number, eval=FALSE}
# Comparing runs with 10 and 100 particles released per day (total 2420 vs. 24 200) 
year <- 2018
timespan<-paste0(year,"-2-1-1_to_",year,"-12-31-1")
runs<-c("neutralParticles_10pertimestep","neutralParticles")

for(i in 1:2){
  run_name <- paste0(runs[i],"_",timespan)
  resultfile <- paste0("../results/",run_name,".nc")
  DriftFile <- nc_open(resultfile, write=FALSE) #for nc
  #print(DriftFile)
  #id  <- ncvar_get(DriftFile, 'trajectory')  # Particle ID
  #Create vector of timesteps in days:
  timesteps  <- ncvar_get(DriftFile, 'time')  # seconds since 1970-01-01 00:00:00 
  dates <- as.Date(as.POSIXct(timesteps, origin="1970-01-01"))
  
  days_timestep<-diff(timesteps)[1]/(60*60*24) #days per timestep
  timesteps_days<-rep(NA,length(timesteps));timesteps_days[1]<-days_timestep 
  for (j in 2:length(timesteps_days)){timesteps_days[j]<-timesteps_days[j-1]+days_timestep}
  timesteps_days_rounded<-ceiling(timesteps_days)

  dates_days <- data.frame(day=timesteps_days_rounded,date=dates)
    assign(paste0("dates_days", year), dates_days)
  
  #Extract relevant variables
  status <- ncvar_get(DriftFile, 'status')    #0=active,<0=stranded/not yet released
  release_month <- ncvar_get(DriftFile, 'origin_marker');release_month[status<0]<-NA
  lon <- ncvar_get(DriftFile, 'lon');lon[status<0]<-NA
  lat <- ncvar_get(DriftFile, 'lat');lat[status<0]<-NA
  depth <- ncvar_get(DriftFile, 'z');depth[status<0]<-NA
  age_seconds <- ncvar_get(DriftFile, 'age_seconds');age_seconds[status<0]<-NA
  age_days <- floor(age_seconds/(60*60*24))
  bottom_depth <- ncvar_get(DriftFile, 'sea_floor_depth_below_sea_level');bottom_depth[status<0]<-NA
  
  nc_close(DriftFile)
  
  # Make dataframe of relevant variables
  dayvector <- rep(timesteps_days_rounded, each = dim(release_month)[2])
  datevector <- rep(dates, each = dim(release_month)[2])
  
  dat <- pivot_longer(as.data.frame(release_month), cols= 1:dim(release_month)[2], values_to = "release_month", names_to = "ID")  %>%
        mutate(day=dayvector)  %>%
        mutate(date=datevector)  %>%
        mutate(age=c(t(age_days)))  %>%
        mutate(lon=c(t(lon)))  %>%
        mutate(lat=c(t(lat)))  %>%
        mutate(depth=c(t(depth)))   %>%
        filter(!is.na(release_month))
    
  assign(paste0(run_name,"_dat"), dat)
  
  
  rm(resultfile, DriftFile, timesteps, days_timestep, timesteps_days, timesteps_days_rounded, release_month, status, lon, lat, depth, age_seconds, age_days, datevector)
}

# Comparing mean particle depth:

plotlist <- list()
for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  
  plot_dep <- get(paste0(run_name,"_dat")) %>% 
   filter(age != 0) %>%
   group_by(date) %>% 
   summarise(depth = mean(depth)) %>%
    ggplot(aes(x=date,y=depth)) +
  geom_line()+
  ylim(c(-50, 0 )) +
  ylab("Mean particle depth") +
  theme_minimal() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
  ggtitle(paste0(year,": ", runs[x]))
  
  plotlist <- append(plotlist, list(plot_dep)) 

}
grid.arrange(grobs = plotlist, ncol = 2)  


# Comparing cumulative particle distribution

plotlist <- list()

for(x in 1:2){
  run_name <- paste0(runs[x],"_",timespan)
  dat <- get(paste0(run_name,"_dat"))
  dat_sp <- SpatialPointsDataFrame(cbind(dat$lon,dat$lat), data=dat)
  
  # Counting the number of particles:
  rasterNumParts <- rasterize(x=dat_sp[,"ID"], y=fullRaster, fun="count")
  rasterNumParts <- as.data.frame(rasterNumParts , xy=T, na.rm=T)
  rasterNumParts$Number <- rasterNumParts$ID
 
 maxval <- max(rasterNumParts$Number)

 if(x == 1){zlims <- c(0,300)} else {
    zlims <- c(0,3000)
  }
 
  fullmap <- ggmap(maparea_all) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red")) +
    coord_cartesian() +
    #scale_fill_gradientn(colours=topo.colors(500, alpha=0.4), name="Number") +
    geom_rect(aes(xmin = 17.7, xmax = 19.2, ymin =
        min(rasterNumParts$y), ymax = 69.7), color="black",fill=NA) + 
    ggtitle(paste0(year,": ", runs[x],"\nMax: ", round(maxval))) +
    theme(plot.margin = unit(rep(.5, 4), "lines"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

  zoommap <- ggmap(maparea_zoom) + 
    geom_raster(data = rasterNumParts, aes(x = x, y = y, fill=Number), interpolate = TRUE) +
    coord_cartesian() +
    scale_fill_gradientn(limits = zlims,
                         na.value = "red", #na.value color same as color for max value
                         colours = c("purple","blue", "green","yellow","orange","red")) +
    xlab("Lon (°E)") + ylab("Lat (°N)") +
    theme(plot.margin = unit(rep(.5, 4), "lines"),
          axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

plotlist <- append(plotlist, list(fullmap, zoommap)) 
  
rm(dat)
}

grid.arrange(grobs = plotlist, layout_matrix = matrix(c(1:4),nrow=2,byrow=FALSE))


```


# References